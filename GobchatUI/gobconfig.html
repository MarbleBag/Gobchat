<html>
<head>
	 <meta charset="utf-16" />
	<link rel="stylesheet" href="lib/jquery/jquery-ui.min.css">
	
	<script src="lib/jquery-3.4.1.min.js"></script>
	<link rel="stylesheet" href="lib/jquery-ui-1.12.1.min.css">
	<script src="lib/jquery-ui-1.12.1.min.js"></script>
	<script src="lib/lodash.min.js"></script>
	<link rel="stylesheet" href="lib/spectrum.css">
	<script src="lib/spectrum.js"></script>

	<script src="gobchat/Datacenters.js"></script>
	<script src="gobchat/Channels.js"></script>
	<script src="gobchat/DefaultConfig.js"></script>
	<script src="gobchat/Common.js"></script>
	
	<script src="gobchat/GobchatConfig.js"></script>
	
	<script src="gobconfig-ui.js"></script>
</head>
<body>
	<style>
		.side-navigation{
			margin: 0;
			padding: 0;
			width: 150px;
			background-color: #f1f1f1;
			position: fixed;
			z-index: 1;
			height: 100%
			overflow: auto
		}
		
		.side-navigation > *{
			display: block;
			color: black;
			padding: 16px;
			text-decoration: none;
		}
		
		.side-navigation > *.active {
			background-color: #4caf50;
			color: white;
		}
		
		.side-navigation > *:hover:not(.active){
			background-color: #555555;
			color: white;
		}
		
		.content {
			margin-left: 150px;
			padding: 1px 16px;
			height: 100%
		}
		
		.btn-system{
			background-color: #dcdcdc
		}
		
		.btn-system:hover{
		
		}
	</style>

	<div id="mainNavigationBar" class="side-navigation">
		<a data-nav-target="nav_general" class="active">General</a>
		<a data-nav-target="nav_channels">Channels</a>
		<a data-nav-target="nav_roleplay">Roleplay</a>
		<a data-nav-target="nav_about">About</a>
		<a class="btn-system" id="save_config">Save</a>
		<a class="btn-system" id="reset_config">Defaults</a>
	</div>
	
	<main class="content">
		<section>
			<article id="nav_general" >
				<p>
					<div>
						<label>Test</label>
						<select id="dropdown_language" disabled="true">
							<option value="en">English</option>
							<option value="de">Deutsch</option>
						</select>
					</div>
				</p>
				<p>
					<div>
						<label>Mentions</label>
						<textarea  rows="3" id="txt_mentions" style="width:100%;"></textarea>
					</div>
				</p>
				<p>
					<div>
						<label>Autodetect emotes in say channel</label>
						<input type="checkbox" id="input_autoemote">
					</div>
				</p>
				<p>	
					<div>
						<label>Fonts: (picks the first available, or generic font type: serif, sans-serife, monospace)</label>							
						<input type="text" id="general_font" style="width:100%;">	
						<button id="general_font_reset" >&#x274C;</button>							
					</div>
				</p>
				<p>
					<div>
						<label>Font size:</label>
						<select id="general_font_size" >
							<option value="small">Small</option>
							<option value="medium">Medium</option>
							<option value="large">Large</option>
						</select>
					</div>
				</p>
			</article>
			<article id="nav_channels">
				<div>
					<table id="tbl_channel_config">
						<thead>
							<tr>
								<th>Channel Name</th>
								<th>Visible</th>
								<th>Mention</th>
								<th>Roleplay</th>
								<th>Text Color</th>
								<th>Background Color</th>
							<tr>	
						</thead>
						<tbody>							
						</tbody>
					</table>
				</div>
			</article>
			<article id="nav_roleplay">
				<div>
					<table id="tbl_segment_config">
						<thead>
							<tr>
								<th>Segment Name</th>								
								<th>Text Color</th>
							<tr>	
						</thead>
						<tbody>							
						</tbody>
					</table>
				</div>
			</article>
			<article id="nav_about">
				<label>Test 3</label>
			</article>
		</section>
	</main>


	<script>
		'use strict';
		//TODO automat detection of config elements and type
				
		$( function() {
			$( "#accordion" ).accordion({
				collapsible: true,
				heightStyle: "fill",
			});
		});		
		
		jQuery(function ($) { //navbar
			const navAttribute = "data-nav-target"
			const navigationBarId = "mainNavigationBar"
		
			function hideNavigationContent(navigationId){
				$(`#${navigationId} > a`).each(function(){
					const target = $(this).attr(navAttribute)
					if(target){
						$(`#${target}`).hide()
					}
				})
			}
			
			function showActiveNavigationContent(navigationId){
				$(`#${navigationId} > .active`).each(function(){
					const target = $(this).attr(navAttribute)
					if(target)
						$(`#${target}`).show()				
				})
			}
			
			function hasNavigationAttribute(element){
				const target = $(element).attr(navAttribute)
				return target !== null && target !== undefined
			}
			
			hideNavigationContent(navigationBarId)
			showActiveNavigationContent(navigationBarId)
			
			$(`#${navigationBarId}`).on("click",function(event){
				if(!hasNavigationAttribute(event.target)) return				
				hideNavigationContent(navigationBarId)				
				$(`#${navigationBarId} > .active`).removeClass("active")
				$(event.target).addClass("active")
				showActiveNavigationContent(navigationBarId)		
			})
		})
				
		jQuery(function ($) {
			const gobconfig	= new Gobchat.GobchatConfig()
			gobconfig.loadFromLocalStore()
		
			const channelTblConfig = [
				{label:"General", 	channelEnum:null, 		styleId:"style.channel.base"},
				
				{label:"Say", 			channelEnum:"SAY", 			styleId:"style.channel.say"},
				{label:"Emote", 		channelEnum:"EMOTE", 		styleId:"style.channel.emote"},
				{label:"Yell", 			channelEnum:"YELL", 		styleId:"style.channel.yell"},
				{label:"Shout", 		channelEnum:"SHOUT", 		styleId:"style.channel.shout"},
				{label:"Party", 		channelEnum:"PARTY", 		styleId:"style.channel.party"},
				{label:"Guild", 		channelEnum:"GUILD", 		styleId:"style.channel.guild"},				
				{label:"Tell send",		channelEnum:"TELL_SEND", 	styleId:"style.channel.tellsend"},
				{label:"Tell recieve", 	channelEnum:"TELL_RECIEVE",	styleId:"style.channel.tellrecieve"},				
				{label:"Alliance", 		channelEnum:"ALLIANCE", 	styleId:"style.channel.alliance"},
				
				{label:"NPC speech",		channelEnum:"NPC_TALK", 		styleId:null},
				{label:"Animated emote", 	channelEnum:"ANIMATED_EMOTE", 	styleId:null},
				{label:"Echo", 				channelEnum:"ECHO", 			styleId:null},
				{label:"Error Messages",	channelEnum:"ERROR", 			styleId:null},
				
				{label:"Linkshell 1", channelEnum:"LINKSHELL_1", 	styleId:"style.channel.linkshell-1"},
				{label:"Linkshell 2", channelEnum:"LINKSHELL_2", 	styleId:"style.channel.linkshell-2"},
				{label:"Linkshell 3", channelEnum:"LINKSHELL_3", 	styleId:"style.channel.linkshell-3"},
				{label:"Linkshell 4", channelEnum:"LINKSHELL_4", 	styleId:"style.channel.linkshell-4"},
				{label:"Linkshell 5", channelEnum:"LINKSHELL_5", 	styleId:"style.channel.linkshell-5"},
				{label:"Linkshell 6", channelEnum:"LINKSHELL_6", 	styleId:"style.channel.linkshell-6"},
				{label:"Linkshell 7", channelEnum:"LINKSHELL_7", 	styleId:"style.channel.linkshell-7"},
				{label:"Linkshell 8", channelEnum:"LINKSHELL_8", 	styleId:"style.channel.linkshell-8"},
				
					
				{label:"Cross-world Linkshell 1", channelEnum:"WORLD_LINKSHELL_1", 	styleId:"style.channel.worldlinkshell-1"},			
				{label:"Cross-world Linkshell 2", channelEnum:"WORLD_LINKSHELL_2", 	styleId:"style.channel.worldlinkshell-2"},	
				{label:"Cross-world Linkshell 3", channelEnum:"WORLD_LINKSHELL_3", 	styleId:"style.channel.worldlinkshell-3"},	
				{label:"Cross-world Linkshell 4", channelEnum:"WORLD_LINKSHELL_4", 	styleId:"style.channel.worldlinkshell-4"},
				{label:"Cross-world Linkshell 5", channelEnum:"WORLD_LINKSHELL_5", 	styleId:"style.channel.worldlinkshell-5"},
				{label:"Cross-world Linkshell 6", channelEnum:"WORLD_LINKSHELL_6", 	styleId:"style.channel.worldlinkshell-6"},	
				{label:"Cross-world Linkshell 7", channelEnum:"WORLD_LINKSHELL_7", 	styleId:"style.channel.worldlinkshell-7"},	
				{label:"Cross-world Linkshell 8", channelEnum:"WORLD_LINKSHELL_8", 	styleId:"style.channel.worldlinkshell-8"},	
			]
			
			const segmentTblConfig = [
				{label:"Say", styleId:"style.segment.say"},
				{label:"Emote", styleId:"style.segment.emote"},
				{label:"OoC", styleId:"style.segment.ooc"},
				{label:"Mention", styleId:"style.segment.mention"},
			]
			
			function addToTableRow(rowElement, element){
				const td = document.createElement("td")
				if(element){					
					td.appendChild(element)					
				}
				rowElement.appendChild(td)
			}
			
			function makeChannelNameLabel(entry){
				if(entry.label===null || entry.label===undefined){
					return null
				}
				const lbl = document.createElement("label")
				lbl.innerHTML = entry.label
				return lbl
			}
			
			function makeCheckboxForChannelBehaviour(entry,type){
				if(entry.channelEnum===null || entry.channelEnum===undefined){
					return null
				}
			
				const input = document.createElement("input")
				input.type = "checkbox"
				const channelEnum = Gobchat.ChannelEnum[entry.channelEnum]
				const configKey = `behaviour.channel.${type}` 
				
				const data = gobconfig.get(configKey)
				
				if( channelEnum === undefined || channelEnum === null || data === undefined || data === null ){
					input.disabled = true
					return
				}				
				
				input.checked  = _.includes(data,channelEnum)
				$(input).on("change",function(event){
						if(event.target.checked && !_.includes(data,channelEnum)){
							data.push(channelEnum)
						}else{
							_.remove(data,(i)=>{return i===channelEnum})
						}
					})				
					
				return input
			}
			
			let spectrumColorPalette = channelTblConfig.map(e=>e.styleId).filter(e=>e!==null&&e!==undefined).map(e=>e + ".color").map(e=>gobconfig.get(e)).filter(e=>e!==null&&e!==undefined)
			spectrumColorPalette = _.union(spectrumColorPalette)
			
			function makeColorSelectorForChannel(entry,type){
				if(entry.styleId===null || entry.styleId===undefined){
					return null
				}
			
				const div = document.createElement("div")
				const input = document.createElement("input")
				div.appendChild(input)
				
				const configKey = entry.styleId + "." + type
				const data = gobconfig.get(configKey)
				
				input.type = "text"		
				$(input).spectrum({
					preferredFormat: "hex3",
					color: data,
					allowEmpty:true,
					showInput: true,
					showInitial: true,
					showAlpha: true,
					showPalette: true,
					palette: spectrumColorPalette,
					showSelectionPalette: true,
					selectionPalette: [],
					maxSelectionSize: 6,
					clickoutFiresChange: false,
					hide: function(color) {
							if(color !== null){
								gobconfig.set(configKey,color.toString())
							}else{
								gobconfig.set(configKey,null)
							}
						},
				})
								
				const btn = document.createElement("button")
				btn.innerHTML = "&#x274C;"
				btn.title = "Reset to default"
				
				$(btn).on("click",function(event){
						gobconfig.reset(configKey)
						$(input).spectrum("set", gobconfig.get(configKey));
					})	
				
				div.appendChild(btn)
				
				return div
			}
			
			{
				const tbl = $("#tbl_channel_config > tbody")
				channelTblConfig.forEach((entry)=>{
					const tr = document.createElement("tr")
					tbl.append(tr)
					
					addToTableRow(tr,makeChannelNameLabel(entry))
					addToTableRow(tr,makeCheckboxForChannelBehaviour(entry,"visible"))
					addToTableRow(tr,makeCheckboxForChannelBehaviour(entry,"mention"))
					addToTableRow(tr,makeCheckboxForChannelBehaviour(entry,"roleplay"))
					
					addToTableRow(tr,makeColorSelectorForChannel(entry,"color"))
					addToTableRow(tr,makeColorSelectorForChannel(entry,"background-color"))
				})
			}
			
			{
				const tbl = $("#tbl_segment_config > tbody")
				segmentTblConfig.forEach((entry)=>{
					const tr = document.createElement("tr")
					tbl.append(tr)					
					addToTableRow(tr,makeChannelNameLabel(entry))					
					addToTableRow(tr,makeColorSelectorForChannel(entry,"color"))					
				})
			}
			
			
			$("#dropdown_language").val(gobconfig.get("behaviour.language"))
			$("#dropdown_language").on("change",function(event){
				const newLanguage = event.target.value || "en"
				gobconfig.set("behaviour.language",newLanguage)
			})
			
			
			$("#txt_mentions").val(gobconfig.get("behaviour.mentions").join(", "))
			$("#txt_mentions").on("change",function(event){
				let words = (event.target.value || "").split(",")
				words = words.filter(w=>w!==null&&w!==undefined).map(w=>w.toLowerCase().trim()).filter(w=>w.length>0)
				gobconfig.set("behaviour.mentions",words)
				event.target.value = words.join(", ")
			})
			
			
			$("#input_autoemote").prop('checked',gobconfig.get("behaviour.autodetectEmoteInSay"))
			$("#input_autoemote").on("change",function(event){					
				gobconfig.set("behaviour.autodetectEmoteInSay",event.target.checked)
			})
			
			$("#general_font").val(gobconfig.get("style.channel.base.font-family"))
			$("#general_font").on("change",function(event){
				let newFont = event.target.value || "sans-serif"
				gobconfig.set("style.channel.base.font-family",newFont)
			})
			
			$("#general_font_reset").on("click",function(event){
				gobconfig.reset("style.channel.base.font-family")
				$("#general_font").val(gobconfig.get("style.channel.base.font-family"))
			})
		
			$("#general_font_size").val(gobconfig.get("style.channel.base.font-size"))
			$("#general_font_size").on("change",function(event){
				let newSize = event.target.value || "medium"
				if(Gobchat.isNumber(newSize)){
					const number = Math.round(newSize)
					newSize = number + "px"
				}
				gobconfig.set("style.channel.base.font-size",newSize)
			})
		
											
			$("#save_config").on("click",function(e){
				gobconfig.saveToLocalStore()
				window.close()
				window.opener.postMessage("Done",'*')
			});
			
			$("#reset_config").on("click",function(e){
				if(window.confirm("Restore current settings to default?\nPress save afterwards.")){
					gobconfig.restoreDefaultConfig()
					gobconfig.saveToLocalStore()
					window.location.reload(false); 
				}
			});
		});
	</script>
	
	<script type="text/javascript">
		'use strict';
		
		class ColorControl{
			constructor(options){
				const defaultOptions = {
			
				}
			
				options = $.extend({},defaultOptions,options)
			}
		}
		
		class TableManager{
			constructor(){
				this.htmlElement = null
				this.data = []
			}
						
			buildTable(){
				buildTable1(this)
			}
		}
		
		function buildTable1(control){
			if(!control.htmlElement) return
			const tblParent = control.htmlElement
			while (tblParent.firstChild) {
				tblParent.firstChild.remove();
			}
			
			{
				const toolbar = document.createElement("div")
				const btnAddAll = document.createElement("button")
				const btnRemoveAll = document.createElement("button")
			}
			
			{
			
			}
		}
		
	</script>
</body>
</html>