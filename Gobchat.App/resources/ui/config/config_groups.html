<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title></title>
</head>
<body>
    <button class="gob-button-tertiary gob-button-copypage" id="cgroups_copyprofile"><i class="fas fa-clone"></i></button>

    <p>
        <div></div>
    </p>
    <p>

        <div>
            <button id="cgroups_addnewgrouptop"
                    class="gob-button-secondary">
                <i class="fa fa-plus"></i>
                <span data-gob-locale-text="config.groups.newgroup"></span>
            </button>
        </div>

        <div id="cgroups_groups">
        </div>

        <div>
            <button id="cgroups_addnewgroupbot"
                    class="gob-button-secondary">
                <i class="fa fa-plus"></i>
                <span data-gob-locale-text="config.groups.newgroup"></span>
            </button>
        </div>

        <template id="cgroups_template_groupentry">
            <div data-gob-groupid>
                <h4>
                    <span class="ui-gc-group-header">
                        <span>
                            <span class="tmpl-header-index"></span>
                            <span class="tmpl-header-prefix">. <span data-gob-locale-text="config.groups.group.naming"></span>: </span>
                            <span class="tmpl-header-name"></span>
                        </span>
                        <span style="float:right;">
                            <button class="tmpl-delete-group gob-button-tertiary gob-button-delete"
                                    data-gob-locale-title="config.groups.group.delete.tooltip">
                                <i class="fa fa-trash"></i>
                            </button>
                        </span>
                    </span>
                </h4><!--&#x274C;-->
                <div>
                    <div class="group-body">
                        <div class="gob-config-group">
                            <div class="gob-config-group-item">
                                <div>
                                    <div data-gob-locale-text="config.groups.group.name"></div>
                                    <input type="text" class="tmpl-group-name" />
                                    <button class="tmpl-group-name-reset gob-button-tertiary gob-button-reset"
                                            data-gob-locale-title="config.main.resetbutton.tooltip">
                                        <i class='fas fa-undo-alt'></i>
                                    </button>
                                </div>
                            </div>
                            <div class="gob-config-group-item">
                                <div>
                                    <input type="checkbox" class="tmpl-group-active" />
                                    <div data-gob-locale-text="config.groups.group.active"></div>
                                </div>
                            </div>
                        </div>

                        <table style="width:100%;">
                            <tr>
                                <td>
                                    <label>
                                        <span data-gob-locale-text="config.groups.group.sender.forground"
                                              data-gob-locale-title="config.groups.group.sender.forground.title"></span>
                                    </label>
                                </td>
                                <td>
                                    <div>
                                        <input type="text" class="tmpl-sender-fgcolor" />
                                        <button class="tmpl-sender-fgcolor-reset gob-button-tertiary gob-button-reset"
                                                data-gob-locale-title="config.main.resetbutton.tooltip">
                                            <i class='fas fa-undo-alt'></i>
                                        </button>
                                    </div>
                                </td>
                                <td>
                                    <label>
                                        <span data-gob-locale-text="config.groups.group.sender.background"
                                              data-gob-locale-title="config.groups.group.sender.background.title"></span>
                                    </label>
                                </td>
                                <td>
                                    <div>
                                        <input type="text" class="tmpl-sender-bgcolor" />
                                        <button class="tmpl-sender-bgcolor-reset gob-button-tertiary gob-button-reset"
                                                data-gob-locale-title="config.main.resetbutton.tooltip">
                                            <i class='fas fa-undo-alt'></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <label>
                                        <span data-gob-locale-text="config.groups.group.message.background"
                                              data-gob-locale-title="config.groups.group.message.background.title"></span>
                                    </label>
                                </td>
                                <td>
                                    <div>
                                        <input type="text" class="tmpl-msg-bgcolor" />
                                        <button class="tmpl-msg-bgcolor-reset gob-button-tertiary gob-button-reset"
                                                data-gob-locale-title="config.main.resetbutton.tooltip">
                                            <i class='fas fa-undo-alt'></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td colspan="4">
                                    <label>
                                        <span data-gob-locale-text="config.groups.group.trigger"
                                              data-gob-locale-title="config.groups.group.trigger.tooltip"></span>
                                    </label>
                                </td>
                            </tr>
                            <tr>
                                <td colspan="4">
                                    <textarea class="tmpl-group-triggers" rows="5" style="width:100%;" data-gob-locale-title="config.groups.group.trigger.tooltip"></textarea>
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
        </template>

        <script type="text/javascript">
            'use strict';
            (async function () {
                const GroupIdAttribute = "data-gob-groupid"
                const ConfigKeyGroupSorting = "behaviour.groups.sorting"
                const ConfigKeyGroups = "behaviour.groups.data"

                const tblGroups = $("#cgroups_groups")
                async function populateGroupTable() {
                    clearGroupTable()

                    const groupIds = gobconfig.get(ConfigKeyGroupSorting)
                    groupIds.forEach(groupId => addGroupToTable(groupId))

                    tblGroups.sortable("refresh")
                    tblGroups.accordion("refresh")

                    tblGroups.find(".tmpl-header-index").each(function (idx) {
                        $(this).text(idx + 1)
                    })

                    await goblocale.updateElement(tblGroups)
                }

                function clearGroupTable() {
                    tblGroups.find("div[data-gob-groupid]").each(function (idx) {
                        $(this).data("configbinding").clear()
                    })
                    tblGroups.empty()
                }

                const tmplGroupEntry = $("#cgroups_template_groupentry")
                function addGroupToTable(groupId) {
                    const binding = GobConfigHelper.makeDatabinding(gobconfig)

                    const groupConfigKey = `${ConfigKeyGroups}.${groupId}`
                    const groupData = gobconfig.get(groupConfigKey)

                    const groupEntry = $(tmplGroupEntry.html())
                    groupEntry.appendTo(tblGroups)

                    groupEntry.attr(GroupIdAttribute, groupId)
                    groupEntry.data("configbinding", binding)

                    const lblGroupName = groupEntry.find(".tmpl-header-name")
                    GobConfigHelper.setConfigKey(lblGroupName, groupConfigKey + ".name")
                    GobConfigHelper.bindText(binding, lblGroupName)

                    const btnDeleteGroup = groupEntry.find(".tmpl-delete-group")
                    btnDeleteGroup.on("click", (event) => {
                        event.stopPropagation()
                        {
                            (async () => {
                                try {
                                    const deleteConfirmation = await goblocale.get("config.groups.entry.deleteconfirm")
                                    if (!window.confirm(deleteConfirmation)) return

                                    gobconfig.remove(groupConfigKey)
                                    const order = gobconfig.get(ConfigKeyGroupSorting)
                                    _.remove(order, e => e === entryId)
                                    gobconfig.set(ConfigKeyGroupSorting, order)
                                } catch (e1) {
                                    console.error(e1)
                                }
                            })()
                        }
                    })

                    const isFFGroup = "ffgroup" in groupData
                    if (isFFGroup)
                        btnDeleteGroup.attr("disabled", true).hide()

                    const txtGroupName = groupEntry.find(".tmpl-group-name")
                    GobConfigHelper.setConfigKey(txtGroupName, groupConfigKey + ".name")
                    GobConfigHelper.bindElement(binding, txtGroupName)

                    const btnGroupName = groupEntry.find(".tmpl-group-name-reset")
                    GobConfigHelper.setConfigKey(btnGroupName, GobConfigHelper.getConfigKey(txtGroupName))
                    GobConfigHelper.makeResetButton(btnGroupName)
                    if (!isFFGroup)
                        btnGroupName.attr("disabled", true).hide()

                    const ckbIsActive = groupEntry.find(".tmpl-group-active")
                    GobConfigHelper.setConfigKey(ckbIsActive, groupConfigKey + ".active")
                    GobConfigHelper.bindCheckbox(binding, ckbIsActive)

                    function makeColorSelector(classId, configKey) {
                        const colorSelector = groupEntry.find(`.${classId}`)
                        GobConfigHelper.setConfigKey(colorSelector, configKey)
                        GobConfigHelper.makeColorSelector(colorSelector)
                        GobConfigHelper.bindColorSelector(binding, colorSelector)

                        const resetButton = groupEntry.find(`.${classId}-reset`)
                        GobConfigHelper.setConfigKey(resetButton, configKey)
                        GobConfigHelper.makeResetButton(resetButton)

                        if (!isFFGroup)
                            resetButton.hide()
                    }

                    makeColorSelector("tmpl-sender-fgcolor", groupConfigKey + ".style.header.color")
                    makeColorSelector("tmpl-sender-bgcolor", groupConfigKey + ".style.header.background-color")
                    makeColorSelector("tmpl-msg-bgcolor", groupConfigKey + ".style.body.background-color")

                    const txtTriggers = groupEntry.find(".tmpl-group-triggers")
                    if (!isFFGroup) {
                        txtTriggers.val(gobconfig.get(groupConfigKey + ".trigger").join(", "))
                        txtTriggers.on("change", (event) => {
                            let words = (event.target.value || "").split(",")
                            words = words.filter(w => w !== null && w !== undefined).map(w => w.toLowerCase().trim()).filter(w => w.length > 0)
                            gobconfig.set(groupConfigKey + ".trigger", words)
                            event.target.value = words.join(", ")
                        })
                    } else {
                        txtTriggers.closest("tr").hide().prev().hide()
                    }

                    binding.initialize()
                }

                function makeNewGroup(addFront) {
                    const groups = gobconfig.get(ConfigKeyGroups)
                    const groupId = GobConfigHelper.generateId(6, Object.keys(groups))

                    groups[groupId] = {
                        name: "Unnamed",
                        id: groupId,
                        active: true,
                        trigger: [],
                        style: {
                            body: { "background-color": null, },
                            header: { "background-color": null, "color": null, },
                        },
                    }

                    gobconfig.set(ConfigKeyGroups, groups)
                    const sorting = gobconfig.get(ConfigKeyGroupSorting)
                    if (addFront) {
                        sorting.unshift(groupId)
                    } else {
                        sorting.push(groupId)
                    }
                    gobconfig.set(ConfigKeyGroupSorting, sorting)
                }

                const btnAddNewGroupTop = $("#cgroups_addnewgrouptop")
                btnAddNewGroupTop.on("click", function () {
                    makeNewGroup(true)
                })

                const btnAddNewGroupBottom = $("#cgroups_addnewgroupbot")
                btnAddNewGroupBottom.on("click", function () {
                    makeNewGroup(false)
                })

                tblGroups.accordion({
                    heightStyle: "content",
                    header: "> div > h4",
                })
                    .sortable({
                        axis: "y",
                        handle: "h4",
                        stop: function (event, ui) {
                            //update sort order
                            let order = []
                            tblGroups.find("div[data-gob-groupid]").each(function () {
                                order.push($(this).attr(GroupIdAttribute))
                                //order.push($(this).data("groupId"))
                            })

                            order = order.filter(e => e !== null && e !== undefined && e.length > 0)
                            gobconfig.set(ConfigKeyGroupSorting, order)

                            // Refresh accordion to handle new order
                            // updateGroupRenderer()
                        }
                    });

                gobconfig.addProfileEventListener((event) => {
                    (async () => {
                        if (event.type === "active")
                            await populateGroupTable()
                    })()
                })
                gobconfig.addPropertyEventListener(ConfigKeyGroupSorting, (event) => {
                    (async () => {
                        if (event.isActive)
                            await populateGroupTable()
                    })()
                })

                await populateGroupTable()

                const btnCopyProfile = $("#cgroups_copyprofile")
                const copyKeys = ["behaviour.groups.data", "behaviour.groups.sorting"]
                GobConfigHelper.makeCopyProfileButton(btnCopyProfile, { configKeys: copyKeys })
            }())
        </script>
    </p>
</body>
</html>