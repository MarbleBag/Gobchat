<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title></title>
</head>
<body>
    <button class="gob-button-tertiary gob-button-copypage" id="cmentions_copyprofile">
        <i class="fas fa-clone"></i>
    </button>

    <p>
        <div>
            <button disabled hidden id="cmentions_add_new_mention1"
                    data-gob-locale-title="config.mentions.newmention.tooltip">
                <i style="color:green;" class="fas fa-plus-circle"></i>
            </button>
        </div>
    </p>

    <p>
        <div>
            <div id="cmentions_mention_table">
            </div>
            <div>
            </div>
            <div>
                <button disabled hidden id="cmentions_add_new_mention2"
                        data-gob-locale-title="config.mentions.newmention.tooltip">
                    <i style="color:green;" class="fas fa-plus-circle"></i>
                </button>
            </div>
        </div>
    </p>

    <template id="cmention_template_mention">
        <div data-gob-entryid class="gob-config-group">
            <div>
                <div class="gob-config-group-label"
                     data-gob-locale-text="config.mentions.mentions.label">
                </div>
                <span>
                    <button hidden class="tmpl-delete-entry gob-button-tertiary gob-button-delete"
                            data-gob-locale-title="config.main.deletebutton.tooltip">
                        <i class="fa fa-trash"></i>
                    </button>
                </span>
            </div>
            <div class="gob-config-group-item">
                <div>
                    <textarea rows="3" class="tmpl-trigger"
                              data-gob-configkey="behaviour.mentions.{0}.trigger"
                              data-gob-locale-title="config.mentions.trigger.tooltip"></textarea>
                </div>
            </div>
            <!-- deactivated til multiple mentions are really needed
            <div>
                <label>Color:</label>
                <input class="tmpl-color-forground" type="text" />
                <button class="tmpl-color-forground-reset ui-gc-btn"
                        title="Resets the field to its default value">
                    <i class='fas fa-undo-alt'></i>
                </button>
            </div>
            -->

            <div class="gob-config-group-item">
                <div>
                    <input type="checkbox" class="tmpl-play-sound"
                           data-gob-configkey="behaviour.mentions.{0}.playsound"
                           data-gob-locale-title="config.mentions.audio.play.tooltip" />
                    <div data-gob-locale-text="config.mentions.audio.play"
                         data-gob-locale-title="config.mentions.audio.play.tooltip"></div>
                </div>
            </div>

            <div class="gob-config-group-item tmp-sound-options" hidden>
                <div>
                    <table>
                        <tr>
                            <td>
                                <div data-gob-locale-text="config.mentions.audio.path"
                                     data-gob-locale-title="config.mentions.audio.path.tooltip"></div>
                            </td>
                            <td>
                                <div>
                                    <input type="text" class="tmpl-sound-path"
                                           data-gob-configkey="behaviour.mentions.{0}.sound"
                                           data-gob-locale-title="config.mentions.audio.path.tooltip" />
                                    <button class="gob-button-tertiary tmpl-sound-selector"
                                            data-gob-locale-title="config.mentions.audio.select.tooltip">
                                        <i class="fas fa-file-audio"></i>
                                    </button>
                                    <button class="gob-button-tertiary tmpl-test-sound"
                                            data-gob-locale-title="config.mentions.audio.test.tooltip">
                                        <i class="fas fa-play"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <div data-gob-locale-text="config.mentions.audio.volume"
                                     data-gob-locale-title="config.mentions.audio.volume.tooltip"></div>
                            </td>
                            <td>
                                <input class="tmpl-sound-volume" type="range" min="0" max="100"
                                       data-gob-locale-title="config.mentions.audio.volume.tooltip" />
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <div data-gob-locale-text="config.mentions.audio.interval"
                                     data-gob-locale-title="config.mentions.audio.interval.tooltip"></div>
                            </td>
                            <td>
                                <input class="tmpl-sound-rest" type="number" min="1"
                                       style="width:50px;"
                                       data-gob-locale-title="config.mentions.audio.interval.tooltip" />
                            </td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
    </template>

    <script type="text/javascript">
        'use strict';

        (async function () {

            const ConfigKeyData = "behaviour.mentions.data"
            const ConfigKeyOrder = "behaviour.mentions.order"
            const EntryIdAttribute = "data-gob-entryid"

            const binding = GobConfigHelper.makeDatabinding(gobconfig)

            const txtMentions = $("#cmentions_mentions")
            GobConfigHelper.bindTextCollection(binding, txtMentions)

            const template = $("#cmention_template_mention")
            const mentionTable = $("#cmentions_mention_table")

            function addEntryToTable(entryId) {
                if (entryId === null || entryId === undefined || entryId.length === 0)
                    throw new Error("Invalid entry id")

                const entry = $(template.html())
                entry.appendTo(mentionTable)
                entry.attr(EntryIdAttribute, entryId)

                const entryBinding = GobConfigHelper.makeDatabinding(gobconfig)
                entry.data("configbinding", entryBinding)

                const configKey = ConfigKeyData + "." + entryId

                const btnDelete = entry.find(".tmpl-delete-entry")
                btnDelete.on("click", event => {
                    event.stopPropagation()
                    {
                        (async () => {
                            const result = await GobConfigHelper.showConfirmationDialog({ dialogText: "config.mentions.entry.delete.dialog" })
                            if (result !== 1) return

                            gobconfig.remove(configKey)
                            const order = gobconfig.get(ConfigKeyOrder)
                            _.remove(order, e => e === entryId)
                            gobconfig.set(ConfigKeyOrder, order)
                        })()
                    }
                })
                btnDelete.attr("disabled", gobconfig.get(ConfigKeyOrder).length <= 1)

                const txtTrigger = entry.find(".tmpl-trigger")
                txtTrigger.val(gobconfig.get(configKey + ".trigger").join(", "))
                txtTrigger.on("change", (event) => {
                    let words = (event.target.value || "").split(",")
                    words = words.filter(w => w !== null && w !== undefined).map(w => w.toLowerCase().trim()).filter(w => w.length > 0)
                    gobconfig.set(configKey + ".trigger", words)
                    txtTrigger.val(words.join(", "))
                })

                /* deactivated til multiple mentions are really needed
                function makeColorSelector(classId, configKey) {
                    const selectorElement = entry.find(`.${classId}`)
                    selectorElement.attr(GobConfigHelper.ConfigKeyAttribute, configKey)
                    GobConfigHelper.makeColorSelector(selectorElement)
                    selectorElement.spectrum("set", gobconfig.get(configKey))

                    const resetButton = entry.find(`.${classId}-reset`)
                    resetButton.on("click", event => {
                        gobconfig.set(configKey, "#9358E4")
                        selectorElement.spectrum("set", gobconfig.get(configKey));
                    })
                }

                makeColorSelector("tmpl-color-forground", configKey + ".style.color")
                */

                const ckbPlaySound = entry.find(".tmpl-play-sound")
                ckbPlaySound.prop("checked", gobconfig.get(configKey + ".playSound"))
                ckbPlaySound.on("change", (event) => {
                    gobconfig.set(configKey + ".playSound", event.target.checked)
                    entry.find(".tmp-sound-options").toggle(event.target.checked)
                })
                entry.find(".tmp-sound-options").toggle(ckbPlaySound.prop("checked"))

                function isSoundFileValid(path) {
                    const isValid = Gobchat.isString(path) && path.length > 0
                    return isValid
                }

                const txtSoundPath = entry.find(".tmpl-sound-path")
                txtSoundPath.val(gobconfig.get(configKey + ".soundPath") || "")
                txtSoundPath.on("change", (event) => {
                    const soundFile = event.target.value
                    const isValid = isSoundFileValid(soundFile)
                    btnCheckSound.attr("disabled", !isValid)
                    gobconfig.set(configKey + ".soundPath", isValid ? soundFile : "")
                })

                const btnSoundSelector = entry.find(".tmpl-sound-selector")
                btnSoundSelector.on("click", (event) => {
                    const fileSelector = document.createElement("input")
                    fileSelector.type = "file"
                    fileSelector.onchange = (event) => {
                        const file = event.target.files[0];
                        if (file)
                            txtSoundPath.val(`../sounds/${file.name}`)
                        else
                            txtSoundPath.val("")
                        txtSoundPath.change()
                        checkPlayability(file.type || "")
                    }
                    fileSelector.click();
                })

                const btnCheckSound = entry.find(".tmpl-test-sound")
                btnCheckSound.attr("disabled", !isSoundFileValid(txtSoundPath.val()))
                btnCheckSound.on("click", (event) => {
                    (async () => {
                        const soundPath = gobconfig.get(configKey + ".soundPath")
                        const audio = new Audio("../" + soundPath);
                        audio.volume = gobconfig.get(configKey + ".volume")

                        try {
                            await audio.play()
                        } catch (e) {
                            console.error(e)
                            GobConfigHelper.showErrorDialog({ dialogText: "config.mentions.audio.test.error" });
                        }
                    })()
                })

                const sldSoundVolume = entry.find(".tmpl-sound-volume")
                const normalize = (value) => { return (value - 0) / (100 - 0) }
                const denormalize = (value) => { return value * (100 - 0) + 0 }
                sldSoundVolume.val(denormalize(gobconfig.get(configKey + ".volume")))
                sldSoundVolume.on("change", (event) => {
                    gobconfig.set(configKey + ".volume", normalize(event.target.value))
                })

                function checkPlayability(format) {
                    const audio = new Audio();
                    const canPlay = audio.canPlayType(format)
                    const result = canPlay === "probably" ? 2 : canPlay === "maybe" ? 1 : 0

                    entry.find(".tmpl-canplay-0, .tmpl-canplay-1, .tmpl-canplay-2").hide()

                    if (result === 0) entry.find(".tmpl-canplay-0").show()
                    if (result === 1) entry.find(".tmpl-canplay-1").show()
                    if (result === 2) entry.find(".tmpl-canplay-2").show()
                }

                const txtSoundRest = entry.find(".tmpl-sound-rest")
                txtSoundRest.val(gobconfig.get(configKey + ".soundInterval") / 1000)
                txtSoundRest.on("change", function (event) {
                    gobconfig.set(configKey + ".soundInterval", (event.target.value || 0) * 1000)
                })

            }

            async function populateTable() {
                clearTableTable()
                const ids = gobconfig.get(ConfigKeyOrder)
                ids.forEach(id => addEntryToTable(id))
                await goblocale.updateElement(mentionTable)
                /* deactivated til multiple mentions are really needed
                mentionTable.sortable("refresh")
                mentionTable.accordion("refresh")
                */
            }

            function clearTableTable() {
                mentionTable.find("div[data-gob-entryid]").each(function (idx) {
                    $(this).data("configbinding").clear()
                })
                mentionTable.empty()
            }

            function addNewEntry() {
                function generateId(ids) {
                    let id = null
                    do {
                        id = Gobchat.generateId(6)
                    } while (_.includes(ids, id))
                    return id
                }

                const data = gobconfig.get(ConfigKeyData)
                const id = generateId(Object.keys(data))

                data[id] = {
                    id: id,
                    trigger: [],
                    playSound: false,
                    soundPath: null,
                    volume: 1.0,
                    /* deactivated til multiple mentions are really needed
                    style: {
                        "color": "#9358E4"
                    }
                    */
                }

                gobconfig.set(ConfigKeyData, data)

                const order = gobconfig.get(ConfigKeyOrder)
                order.push(id)
                gobconfig.set(ConfigKeyOrder, order)
            }

            /* deactivated til multiple mentions are really needed
            mentionTable.accordion({
                heightStyle: "content",
                header: "> div > h4",
            })
                .sortable({
                    axis: "y",
                    handle: "div",
                    stop: function (event, ui) {
                        let order = []
                        mentionTable.find("div[data-gob-entryid]").each(function () {
                            order.push($(this).attr(EntryIdAttribute))
                        })

                        order = order.filter(e => e !== null && e !== undefined && e.length > 0)
                        gobconfig.set(ConfigKeyOrder, order)
                    }
                });
            */

            gobconfig.addProfileEventListener((event) => {
                (async () => {
                    if (event.type === "active")
                        await populateTable()
                })()
            })
            gobconfig.addPropertyEventListener(ConfigKeyOrder, (event) => {
                (async () => {
                    if (event.isActive)
                        await populateTable()
                })()
            })
            await populateTable()

            const btnAddMentionBox = $("#cmentions_add_new_mention1, #cmentions_add_new_mention2")
            btnAddMentionBox.on("click", (event) => addNewEntry())

            binding.initialize()

            const btnCopyProfile = $("#cmentions_copyprofile")
            const copyKeys = ["behaviour.mentions.data", "behaviour.mentions.order"]
            GobConfigHelper.makeCopyProfileButton(btnCopyProfile, { configKeys: copyKeys })
        }());
    </script>
</body>
</html>