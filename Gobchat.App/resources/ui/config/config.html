<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title>Gobconfig</title>

    <script src="../lib/jquery-3.4.1.min.js"></script>
    <link rel="stylesheet" href="../lib/jquery-ui-1.12.1.min.css">
    <script src="../lib/jquery-ui-1.12.1.min.js"></script>
    <script src="../lib/lodash.min.js"></script>
    <link rel="stylesheet" href="../lib/spectrum.css">
    <script src="../lib/spectrum.js"></script>

    <script defer src="../lib/fontawesome/js/all.js"></script>

    <!--
    <link rel="stylesheet" href="../gobui_default.css">
    <link rel="stylesheet" href="config.css">
    -->

    <link rel="stylesheet" href="../gobui_default.css">

    <script src="config.js"></script>
    <script src="../gobchat/gob-databinding.js"></script>
    <script src="../gobchat/gob-jquery-loadthen.js"></script>
</head>
<body class="gob-config-dialog">
    <script type="text/javascript">
        'use strict';

        //if (window.opener) {
        window.GobchatAPI = window.opener.GobchatAPI
        window.Gobchat = window.opener.Gobchat
        window.console = window.opener.console

        window.gobconfig = new Gobchat.GobchatConfig()
        window.gobconfig.loadFromLocalStore()

        //}
    </script>

    <div class="gob-config-dialog-panel" style="display: flex; flex-direction:column; overflow:hidden;">
        <div class="gob-config-dialog-header">
            Gobchat Configuration
        </div>
        <div class="gob-separator-horizontal"></div>
        <div style="display: inline-flex; overflow:hidden;">
            <div id="cmain_navbar" class="gob-column-navigation" data-gob-nav-target="cmain_config_content">
                <select id="cmain_profileselect"></select>
                <div class="gob-separator-horizontal"></div>
                <div class="gob-nav-element gob-selectable-element active" data-gob-nav-target="config_app.html">
                    <div data-gob-locale-text="config.main.nav.app"></div>
                </div>
                <div class="gob-nav-element gob-selectable-element" data-gob-nav-target="config_mentions.html">
                    <div data-gob-locale-text="config.main.nav.mentions"></div>
                </div>
                <div class="gob-nav-element gob-selectable-element" data-gob-nav-target="config_profiles.html">
                    <div class="" data-gob-locale-text="config.main.nav.profiles"></div>
                </div>
                <div class="gob-nav-element gob-selectable-element" data-gob-nav-target="config_channel.html">
                    <div class="" data-gob-locale-text="config.main.nav.channels"></div>
                </div>
                <div class="gob-nav-element gob-selectable-element" data-gob-nav-target="config_groups.html">
                    <div class="" data-gob-locale-text="config.main.nav.groups"></div>
                </div>
                <div class="gob-nav-element gob-selectable-element" data-gob-nav-target="config_roleplay.html">
                    <div class="" data-gob-locale-text="config.main.nav.roleplay"></div>
                </div>
                <div class="gob-nav-element gob-selectable-element" data-gob-nav-target="about.html">
                    <div class="" data-gob-locale-text="config.main.nav.about"></div>
                </div>
                <div class="gob-separator-horizontal"></div>
                <div class="gob-button-column">
                    <button id="cmain_saveconfig" class="gob-button-primary">
                        <i class="fa fa-save"></i>
                        <span data-gob-locale-text="config.main.nav.save"></span>
                    </button>
                    <button id="cmain_saveandexitconfig" class="gob-button-primary">
                        <i class="fa fa-save"></i>
                        <span data-gob-locale-text="config.main.nav.saveandexit"></span>
                    </button>
                    <button id="cmain_cancelconfig" class="gob-button-primary">
                        <i class="fas fa-trash-alt"></i>
                        <span data-gob-locale-text="config.main.nav.cancel"></span>
                    </button>
                </div>
            </div>
            <div class="gob-separator-vertical"></div>
            <div class="gob-nav-panel" id="cmain_config_content">
            </div>
        </div>
    </div>

    <div id="config_copyprofiledialog" title="Select a profile" hidden>
        <select></select>
    </div>

    <div id="config_dialog_error" title="An error occured" hidden>
        <p>
            <span style="float:left; margin:24px 24px 20px 0; color:orangered;"><i class="fas fa-exclamation-triangle fa-3x"></i></span>
            <span id="config_dialog_error_text">hello</span>
        </p>
    </div>

    <script type="text/javascript">

        // import { buildNavigationElement } from "../gobchat/gob-navbar"
        jQuery(function ($) {
            $("#cmain_saveconfig").on("click", function (e) {
                window.gobconfig.saveToLocalStore()
                window.saveConfig()
                //window.close()
                //window.opener.postMessage("Done", '*')
            });

            $("#cmain_saveandexitconfig").on("click", function (e) {
                window.gobconfig.saveToLocalStore()
                window.saveConfig()
                //window.gobresult = "save"
                window.close()
                //window.opener.postMessage("Done", '*')
            });

            $("#cmain_resetconfig").on("click", function (e) {
                if (window.confirm("Restore current settings to default?\nEverything will be deleted!\nPress save afterwards.")) {
                    window.gobconfig.resetProfile()
                    window.gobconfig.saveToLocalStore()
                    window.location.reload(false);
                }
            });

            $("#cmain_cancelconfig").on("click", function (e) {
                if (window.confirm("Cancel? Any unsaved changes will be lost.")) {
                    //window.gobresult = "cancel"
                    window.close()
                    //window.opener.postMessage("Done", '*')
                }
            });

            // $(".ui-btn-copyprofile ").attr("title", "Copy all settings on this page from another profile")

            {
                (async () => {
                    window.goblocale = new Gobchat.GobLocaleManager()
                    window.goblocale.setLocale(gobconfig.get("behaviour.language"))

                    await makeNavigationElement($("#cmain_navbar"))

                    const generalBinding = GobConfigHelper.makeDatabinding(gobconfig)

                    generalBinding.bindConfigListener("behaviour.language", (value) => {
                        window.goblocale.setLocale(value)
                        window.goblocale.updateElement($(document))
                    })

                    const styleLoader = new Gobchat.StyleLoader(document.head, "..")
                    await styleLoader.loadStyles()

                    try {
                        const dpdThemes = $("#capp_theme")
                        dpdThemes.empty()
                        for (let style of styleLoader.styles) {
                            $('<option>', {
                                text: style,
                                value: style
                            }).appendTo(dpdThemes)
                        }
                    } catch (e1) {
                        console.log(e1)
                    }

                    generalBinding.bindConfigListener("style.theme", (value) => {
                        $("body").hide()
                        styleLoader.activateStyle(value)
                        $("#capp_theme").val(value)
                        $("body").show("fast") //trigger reflow so style gets applied everywhere (especially scrollbars!) What a shitty bug
                    })

                    generalBinding.initialize()
                })()
            }
        });

        async function makeNavigationElement(navigationElement) {
            const navAttribute = "data-gob-nav-target"
            const navIdAttribute = "data-gob-nav-id"
            const $navBar = $(navigationElement)
            const $navPanel = $(`#${navigationElement.attr(navAttribute)}`)

            $navElements = $navBar.find(`.gob-nav-element[${navAttribute}]`)

            const awaitPromises = []
            $navElements.each(function () {
                const $panelElement = $("<div class='gob-nav-panel-content' />").appendTo($navPanel)
                const pageToLoad = $(this).attr(navAttribute)
                $panelElement.attr(navIdAttribute, pageToLoad)
                awaitPromises.push($panelElement.loadThen(pageToLoad))

                if ($(this).hasClass("active"))
                    $panelElement.addClass("active")

                $(this).on("click", function () {
                    $navBar.find("> .gob-nav-element.active").removeClass("active")
                    $(this).addClass("active")
                    $navPanel.find("> .gob-nav-panel-content.active").removeClass("active")
                    $panelElement.addClass("active")
                })
            })
            await Promise.all(awaitPromises)
        }
    </script>
</body>
</html>