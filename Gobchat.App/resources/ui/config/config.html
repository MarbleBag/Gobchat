<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title>Gobconfig</title>

    <script src="../lib/jquery-3.4.1.min.js"></script>
    <link rel="stylesheet" href="../lib/jquery-ui-1.12.1.min.css">
    <script src="../lib/jquery-ui-1.12.1.min.js"></script>
    <script src="../lib/lodash.min.js"></script>
    <link rel="stylesheet" href="../lib/spectrum.css">
    <script src="../lib/spectrum.js"></script>

    <script defer src="../lib/fontawesome/js/all.js"></script>

    <link rel="stylesheet" href="../gobui_default.css">
    <link rel="stylesheet" href="config.css">

    <script src="config.js"></script>
    <script src="../gobchat/gob-databinding.js"></script>
    <script src="../gobchat/gob-jquery-loadthen.js"></script>
</head>
<body>
    <script type="text/javascript">
        'use strict';

        //if (window.opener) {
        window.GobchatAPI = window.opener.GobchatAPI
        window.Gobchat = window.opener.Gobchat

        window.gobconfig = new Gobchat.GobchatConfig()
        window.gobconfig.loadFromLocalStore()
        //}
    </script>

    <div id="main_navbar" class="ui-side-navigation">
        <select id="main_profileselect" data-gob-locale-title="config.main.nav.selectprofile.tooltip"></select>
        <a data-nav-target="main_nav_app" data-gob-locale-text="config.main.nav.app" class="active">App</a>
        <a data-nav-target="main_nav_mentions" data-gob-locale-text="config.main.nav.mentions">Mentions</a>
        <a data-nav-target="main_nav_profiles" data-gob-locale-text="config.main.nav.profiles">Profiles</a>
        <a data-nav-target="main_nav_channel" data-gob-locale-text="config.main.nav.channels">Channels</a>
        <a data-nav-target="main_nav_groups" data-gob-locale-text="config.main.nav.groups">Groups</a>
        <a data-nav-target="main_nav_roleplay" data-gob-locale-text="config.main.nav.roleplay">Roleplay</a>
        <a data-nav-target="main_nav_about" data-gob-locale-text="config.main.nav.about">About</a>
        <a class="btn-system" id="main_saveconfig">
            <i class="fa fa-save"></i>
            <label data-gob-locale-text="config.main.nav.save"></label>
        </a>
        <a class="btn-system" id="main_saveandexitconfig">
            <i class="fa fa-save"></i>
            <label data-gob-locale-text="config.main.nav.saveandexit"></label>
        </a>
        <!--<a class="btn-system" id="main_resetconfig"><i class="fa fa-exclamation-circle"></i> Defaults</a>-->
        <a class="btn-system" id="main_cancelconfig">
            <i class="fas fa-trash-alt"></i>
            <label data-gob-locale-text="config.main.nav.cancel"></label>
        </a>
    </div>

    <!--
    <div id="config_navbar" class="gob-ui-navigation-side" data-gob-nav-target="config_content">
        <select id="main_profileselect"></select>
        <a class="active gob-ui-navigation-frame" data-gob-nav-target="config_app.html" data-gob-locale-text="ui.config.main.nav.app">A</a>
        <a class="active gob-ui-navigation-frame" data-gob-nav-target="config_mentions.html" data-gob-locale-text="ui.config.main.nav.mentions">B</a>
        <a class="active gob-ui-navigation-frame" data-gob-nav-target="config_profiles.html" data-gob-locale-text="ui.config.main.nav.profiles">C</a>
        <a class="active gob-ui-navigation-frame" data-gob-nav-target="config_channel.html" data-gob-locale-text="ui.config.main.nav.channels">D</a>
        <a class="active gob-ui-navigation-frame" data-gob-nav-target="config_roleplay.html" data-gob-locale-text="ui.config.main.nav.roleplay">D</a>
        <a class="active gob-ui-navigation-frame" data-gob-nav-target="config_groups.html" data-gob-locale-text="ui.config.main.nav.groups">D</a>
        <a class="active gob-ui-navigation-frame" data-gob-nav-target="about.html" data-gob-locale-text="ui.config.main.nav.about">D</a>
        <a class="btn-system" id="main_saveconfig">
            <i class="fa fa-save"></i>
            <label class="gob-localized" data-gob-locale-text="config.main.nav.save"></label>
        </a>
        <a class="btn-system" id="main_saveandexitconfig">
            <i class="fa fa-save"></i>
            <label class="gob-localized" data-gob-locale-text="config.main.nav.saveandexit"></label>
        </a>
        <a class="btn-system" id="main_cancelconfig">
            <i class="fas fa-trash-alt"></i>
            <label class="gob-localized" data-gob-locale-text="config.main.nav.cancel"></label>
        </a>
    </div>
    -->

    <div id="config_content">
    </div>

    <div class="ui-content">
        <div id="main_nav_app" data-content-src="config_app.html"></div>
        <div id="main_nav_mentions" data-content-src="config_mentions.html"></div>
        <div id="main_nav_profiles" data-content-src="config_profiles.html"></div>
        <div id="main_nav_channel" data-content-src="config_channel.html"></div>
        <div id="main_nav_roleplay" data-content-src="config_roleplay.html"></div>
        <div id="main_nav_groups" data-content-src="config_groups.html"></div>
        <div id="main_nav_about" data-content-src="about.html"></div>
    </div>

    <div id="config_copyprofiledialog" title="Select a profile" hidden>
        <select></select>
    </div>

    <div id="config_dialog_error" title="An error occured" hidden>
        <p>
            <span style="float:left; margin:24px 24px 20px 0; color:orangered;"><i class="fas fa-exclamation-triangle fa-3x"></i></span>
            <span id="config_dialog_error_text">hello</span>
        </p>
    </div>

    <script type="text/javascript">
        'use strict'

        jQuery(function ($) {
            $("#main_saveconfig").on("click", function (e) {
                window.gobconfig.saveToLocalStore()
                window.saveConfig()
                //window.close()
                //window.opener.postMessage("Done", '*')
            });

            $("#main_saveandexitconfig").on("click", function (e) {
                window.gobconfig.saveToLocalStore()
                window.saveConfig()
                //window.gobresult = "save"
                window.close()
                //window.opener.postMessage("Done", '*')
            });

            $("#main_resetconfig").on("click", function (e) {
                if (window.confirm("Restore current settings to default?\nEverything will be deleted!\nPress save afterwards.")) {
                    window.gobconfig.resetProfile()
                    window.gobconfig.saveToLocalStore()
                    window.location.reload(false);
                }
            });

            $("#main_cancelconfig").on("click", function (e) {
                if (window.confirm("Cancel? Any unsaved changes will be lost.")) {
                    //window.gobresult = "cancel"
                    window.close()
                    //window.opener.postMessage("Done", '*')
                }
            });

            $(".ui-btn-copyprofile ").attr("title", "Copy all settings on this page from another profile")

            {
                (async () => {
                    window.goblocale = new Gobchat.GobLocaleManager()
                    window.goblocale.setLocale(gobconfig.get("behaviour.language"))

                    await initializeNavigationBar($("#main_navbar"))

                    const generalBinding = GobConfigHelper.makeDatabinding(gobconfig)
                    generalBinding.bindConfigListener("behaviour.language", (value) => {
                        window.goblocale.setLocale(value)
                        window.goblocale.updateElement($(document))
                    })
                    generalBinding.initialize()
                })()
            }
        });

        async function initializeNavigationBar(navigationElement) {
            const $navigationElement = $(navigationElement)
            const navAttribute = "data-nav-target"

            function isNavigationElement(element) {
                const target = $(element).attr(navAttribute)
                return target !== null && target !== undefined
            }

            function hideAllNavigationContent() {
                $navigationElement.find("> a").each(function () {
                    const targetId = $(this).attr(navAttribute)
                    $(`#${targetId}`).hide()
                })
            }

            function showNavigationContent() {
                $navigationElement.find("> .active").each(function () {
                    const targetId = $(this).attr(navAttribute)
                    $(`#${targetId}`).show()
                })
            }

            var awaitPromises = []

            $navigationElement.find("> a").each(function () {
                const targetId = $(this).attr(navAttribute)
                if (!targetId)
                    return //skip
                const target = $(`#${targetId}`)
                const targetContent = target.attr("data-content-src")
                if (!targetContent)
                    return //skip

                var promise = $(target)
                    .loadThen(targetContent)

                awaitPromises.push(promise)
            })
            await Promise.all(awaitPromises)

            hideAllNavigationContent()
            showNavigationContent()

            $navigationElement.on("click", (event) => {
                if (!isNavigationElement(event.target)) return
                hideAllNavigationContent()

                $navigationElement.find("> .active").removeClass("active")
                $(event.target).addClass("active")

                showNavigationContent()
            })
        }
    </script>
</body>
</html>