<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title></title>
</head>
<body>
    <p>
        <button id="cprofiles_profile_new" class="gob-button-secondary">
            <i class="fas fa-plus"></i>
            <span data-gob-locale-text="config.profiles.newprofile"></span>
        </button>
        <button id="cprofiles_profile_import" class="gob-button-secondary">
            <i class="fas fa-file-import"></i>
            <span data-gob-locale-text="config.profiles.importprofile"></span>
        </button>
    </p>

    <table id="cprofiles_profiles">
        <thead>
            <tr>
                <th data-gob-locale-text="config.profiles.profiles.name"></th>
                <th data-gob-locale-text="config.profiles.profiles.actions"></th>
                <th></th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>

    <div id="cprofiles_copyprofiledialog" title="Basic dialog">
        <select id="cprofiles_copyprofiledialog_select"></select>
    </div>

    <template id="cprofiles_template_profiles_entry">
        <tr draggable="true" data-profile-id>
            <td>
                <input id="profile_name" type="text" />
            </td>
            <td>
                <button id="profile_activate"
                        class="gob-button-secondary gob-button-profileaction">
                    <i class="fas fa-check-square"></i>
                    <span data-gob-locale-text="config.profiles.profile.activate"></span>
                </button>
            </td>
            <td>
                <table>
                    <tr>
                        <td>
                            <button id="profile_export" type="button"
                                    class="gob-button-secondary gob-button-profileaction"
                                    data-gob-locale-title="config.profiles.profile.export.tooltip">
                                <i class="fas fa-file-export"></i>
                                <span data-gob-locale-text="config.profiles.profile.export"></span>
                            </button>
                        </td>
                        <td>
                            <button id="profile_clone"
                                    class="gob-button-secondary gob-button-profileaction"
                                    data-gob-locale-title="config.profiles.profile.clone.tooltip">
                                <i class="fas fa-copy"></i>
                                <span data-gob-locale-text="config.profiles.profile.clone"></span>
                            </button>
                        </td>
                        <td>
                            <button id="profile_copy"
                                    class="gob-button-secondary gob-button-profileaction"
                                    data-gob-locale-title="config.profiles.profile.copy.tooltip">
                                <i class="fas fa-clone"></i>
                                <span data-gob-locale-text="config.profiles.profile.copy"></span>
                            </button>
                        </td>
                        <td>
                            <button id="profile_default"
                                    class="gob-button-secondary gob-button-profileaction"
                                    data-gob-locale-title="config.profiles.profile.reset.tooltip">
                                <i class="fas fa-undo-alt"></i>
                                <span data-gob-locale-text="config.profiles.profile.reset"></span>
                            </button>
                        </td>
                        <td>
                            <button id="profile_delete"
                                    class="gob-button-secondary gob-button-profileaction"
                                    data-gob-locale-title="config.profiles.profile.delete.tooltip">
                                <i class="fas fa-eraser"></i>
                                <span data-gob-locale-text="config.profiles.profile.delete"></span>
                            </button>
                        </td>
                    </tr>
                </table>
            </td>
        </tr>
    </template>

    <script type="text/javascript">
        'use strict';

        (async function (undefined) {

            $("#cprofiles_copyprofiledialog").hide();

            //setup profile selector
            const profileSelectionDropdown = $("#cmain_profileselect")
            profileSelectionDropdown.on("change", function (event) {
                const profileId = event.target.value
                gobconfig.activeProfile = profileId
            })

            function populateProfileSelection() {
                profileSelectionDropdown.empty()
                gobconfig.profiles.forEach((profileId) => {
                    var profile = gobconfig.getProfile(profileId)
                    profileSelectionDropdown.append(new Option(profile.profileName, profileId))
                })
                profileSelectionDropdown.val(gobconfig.activeProfile)
            }

            gobconfig.addProfileEventListener((event) => {
                if (event.type === "active")
                    profileSelectionDropdown.val(event.detail.new)
                else
                    populateProfileSelection()
            })

            gobconfig.addPropertyEventListener("profile.name", (event) => {
                const profileId = profileSelectionDropdown.val()
                populateProfileSelection()
                profileSelectionDropdown.val(profileId)
            })

            populateProfileSelection()

            //setup create profile
            $("#cprofiles_profile_new").on("click", function (event) {
                gobconfig.createNewProfile()
            })

            //setup import profile
            $("#cprofiles_profile_import").on("click", function (event) {
                (async () => {
                    let newProfile = await GobchatAPI.importProfile()
                    if (newProfile === undefined || newProfile === null || newProfile.length == 0) {
                        GobConfigHelper.showErrorDialog({ dialogText: "config.profiles.importprofile.error" });
                        return
                    }

                    newProfile = JSON.parse(newProfile)
                    gobconfig.importProfile(newProfile)
                })()
            })

            const profileTable = $("#cprofiles_profiles > tbody")
            const template = $("#cprofiles_template_profiles_entry")

            async function populateProfileTable() {
                profileTable.empty()
                gobconfig.profiles.forEach((profileId) => {
                    const profile = gobconfig.getProfile(profileId)

                    const rowElement = $(template.html())
                    rowElement.appendTo(profileTable)

                    rowElement.attr("data-profile-id", profile.profileId)

                    const txtProfileName = rowElement.find("#profile_name")
                    txtProfileName.on("change", function (event) {
                        profile.profileName = event.target.value || "Unnamed"
                    })
                    txtProfileName.val(profile.profileName)

                    const btnActiveProfile = rowElement.find("#profile_activate")
                    btnActiveProfile.on("click", function (event) {
                        gobconfig.activeProfile = profile.profileId
                    })
                    if (gobconfig.activeProfile === profile.profileId)
                        btnActiveProfile.attr("disabled", true)

                    const btnExportProfile = rowElement.find("#profile_export")
                    btnExportProfile.on("click", function (event) {
                        (async () => {
                            const selection = await GobchatAPI.saveFileDialog("Json files (*.json)|*.json", `profile_${profile.profileId}.json`)
                            if (selection === null || selection === undefined || selection.length === 0)
                                return
                            await GobchatAPI.writeTextToFile(selection, JSON.stringify(profile.config))
                        })()
                    })

                    const btnCloneProfile = rowElement.find("#profile_clone")
                    btnCloneProfile.on("click", function (event) {
                        const newProfileId = gobconfig.createNewProfile()
                        gobconfig.copyProfile(profile.profileId, newProfileId)
                    })

                    const btnCopyProfile = rowElement.find("#profile_copy")
                    btnCopyProfile.on("click", function (event) {
                        GobConfigHelper.showProfileIdSelectionDialog(selectedId => gobconfig.copyProfile(selectedId, profile.profileId), { exclude: profile.profileId })
                    })

                    if (gobconfig.profiles.length <= 1)
                        btnCopyProfile.attr("disabled", true)

                    const btnDefaultProfile = rowElement.find("#profile_default")
                    btnDefaultProfile.on("click", function (event) {
                        (async () => {
                            const result = await GobConfigHelper.showConfirmationDialog({
                                dialogText: "config.profiles.profile.reset.dialog.text",
                            })

                            if (result === 1) {
                                profile.restoreDefaultConfig()
                            }
                        })()
                    })

                    const btnDeleteProfile = rowElement.find("#profile_delete")
                    btnDeleteProfile.on("click", function (event) {
                        (async () => {
                            const result = await GobConfigHelper.showConfirmationDialog({
                                dialogText: "config.profiles.profile.delete.dialog.text",
                            })

                            if (result === 1) {
                                gobconfig.deleteProfile(profile.profileId)
                            }
                        })()
                    })
                    if (gobconfig.profiles.length <= 1)
                        btnDeleteProfile.attr("disabled", true)
                })
                await goblocale.updateElement(profileTable)
            }

            gobconfig.addProfileEventListener((event) => {
                (async () => {
                    await populateProfileTable()
                })()
            })
            await populateProfileTable()

            gobconfig.addPropertyEventListener("profile.name", (event) => {
                const profile = gobconfig.getProfile(event.source)
                profileTable.find(`tr[data-profile-id='${profile.profileId}']`).find("#profile_name").val(profile.get("profile.name"))
            })

        }());
    </script>
</body>
</html>