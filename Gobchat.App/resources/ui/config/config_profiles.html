<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title></title>
</head>
<body>
    <p>
        <button id="profile_new">Create new profile</button>
        <button id="profile_import">Import profile</button>
    </p>

    <table id="config_profiles">
        <thead>
            <tr>
                <th>Name</th>
                <th>Actions</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>

    <template id="template_config_profiles_entry">
        <tr draggable="true" data-profile-id>
            <td>
                <input id="profile_name" type="text" />
            </td>
            <td>
                <button id="profile_activate" title="Activate">Activate profile</button>
            </td>
            <td>
                <table>
                    <tr>
                        <td>
                            <button id="profile_export" title="Export">Export profile</button>
                        </td>
                        <td>
                            <button id="profile_clone" title="Clone">Clone profile</button>
                        </td>
                        <td>
                            <button id="profile_copy" title="Copy from">Copy from profile</button>
                        </td>
                        <td>
                            <button id="profile_delete" title="delete">Delete profile</button>
                        </td>
                    </tr>
                </table>
            </td>
        </tr>
    </template>

    <script type="text/javascript">

        //setup profile selector
        const profileSelectionDropdown = $("#main_profileselect")
        profileSelectionDropdown.attr("title", "Set your active profile.")

        profileSelectionDropdown.on("change", function (event) {
            const profileId = event.target.value
            gobconfig.activeProfile = profileId
        })

        function populateProfileSelection() {
            profileSelectionDropdown.empty()
            gobconfig.profiles.forEach((profileId) => {
                var profile = gobconfig.getProfile(profileId)
                profileSelectionDropdown.append(new Option(profile.profileName, profileId))
            })
        }

        gobconfig.addProfileEventListener((event) => {
            if (event.type === "active")
                profileSelectionDropdown.val(event.detail.new)
            else
                populateProfileSelection()
        })

        gobconfig.addPropertyEventListener("profile.name", (event) => {
            const profileId = profileSelectionDropdown.val()
            populateProfileSelection()
            profileSelectionDropdown.val(profileId)
        })

        populateProfileSelection()

        //setup create profile
        $("#profile_new").on("click", function (event) {
            gobconfig.createNewProfile()
        })

        //setup import profile
        $("#profile_import").on("click", function (event) {
            alert("OwO")
        })

        // gobconfig.addEventListener("profile.add", (event) => { })
        // gobconfig.addEventListener("profile.remove", (event) => { })
        //  gobconfig.addEventListener("profile.changed", (event) => { })

        const profileTable = $("#config_profiles > tbody")
        const template = $("#template_config_profiles_entry")

        function populateProfileTable() {
            profileTable.empty()
            gobconfig.profiles.forEach((profileId) => {
                const profile = gobconfig.getProfile(profileId)

                const rowElement = $(template.html())
                rowElement.appendTo(profileTable)

                rowElement.attr("data-profile-id", profile.profileId)

                const txtProfileName = rowElement.find("#profile_name")
                txtProfileName.on("change", function (event) {
                    profile.profileName = event.target.value || "Unnamed"
                })
                profile.addPropertyListener("profile.name", function (event) {
                    txtProfileName.val(profile.profileName)
                })
                txtProfileName.val(profile.profileName)

                const btnActiveProfile = rowElement.find("#profile_activate")
                btnActiveProfile.on("click", function (event) {
                    gobconfig.activeProfile = profile.profileId
                })
                if (gobconfig.activeProfile === profile.profileId)
                    btnActiveProfile.attr("disabled", true)

                const btnExportProfile = rowElement.find("#profile_export")
                btnExportProfile.on("click", function (event) {
                    console.log(event.target.id)
                })

                const btnCloneProfile = rowElement.find("#profile_clone")
                btnCloneProfile.on("click", function (event) {
                    const newProfileId = gobconfig.createNewProfile()
                    gobconfig.copyProfile(profile.profileId, newProfileId)
                })

                const btnCopyProfile = rowElement.find("#profile_copy")
                btnCopyProfile.on("click", function (event) {
                    console.log(event.target.id)
                    alert("OwO")
                })

                const btnDeleteProfile = rowElement.find("#profile_delete")
                btnDeleteProfile.on("click", function (event) {
                    gobconfig.deleteProfile(profile.profileId)
                })
                if (gobconfig.profiles.length <= 1)
                    btnDeleteProfile.attr("disabled", true)
            })
        }
        populateProfileTable()

        gobconfig.addProfileEventListener((event) => {
            populateProfileTable()
        })

        gobconfig.addPropertyEventListener("profile.name", (event) => {
            profileTable.find(`tr[data-profile-id='${event.profileId}'] > #profile_name`).val(event.newValue)
        })
    </script>
</body>
</html>