<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title></title>
</head>
<body>
    <p>
        <button id="cprofiles_profile_new"><i class="fas fa-file"></i> Create new profile</button>
        <button id="cprofiles_profile_import" title="(Soon (TM)) Imports a profile file"><i class="fas fa-file-import"></i> Import profile</button>
    </p>

    <table id="cprofiles_profiles">
        <thead>
            <tr>
                <th>Name</th>
                <th>Actions</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>

    <div id="cprofiles_copyprofiledialog" title="Basic dialog">
        <select id="cprofiles_copyprofiledialog_select"></select>
    </div>

    <template id="cprofiles_template_profiles_entry">
        <tr draggable="true" data-profile-id>
            <td>
                <input id="profile_name" type="text" />
            </td>
            <td>
                <button id="profile_activate" title="Activate"><i class="fas fa-check-square"></i> Activate</button>
            </td>
            <td>
                <table>
                    <tr>
                        <td>
                            <button id="profile_export" type="button" title="(Soon (TM)) Exports a profile as a file"><i class="fas fa-file-export"></i> Export</button>
                        </td>
                        <td>
                            <button id="profile_clone" title="Creates a copy of this profile"><i class="fas fa-copy"></i> Clone</button>
                        </td>
                        <td>
                            <button id="profile_copy" title="Overwrites this profile with another profile"><i class="fas fa-clone"></i> Copy from</button>
                        </td>
                        <td>
                            <button id="profile_default" title="Restore defaults for this profile"><i class="fas fa-undo-alt"></i> Reset</button>
                        </td>
                        <td>
                            <button id="profile_delete" title="Delete this profile"><i class="fas fa-eraser"></i> Delete</button>
                        </td>
                    </tr>
                </table>
            </td>
        </tr>
    </template>

    <script type="text/javascript">
        'use strict';

        (function (undefined) {

            $("#cprofiles_copyprofiledialog").hide();

            //setup profile selector
            const profileSelectionDropdown = $("#main_profileselect")
            profileSelectionDropdown.attr("title", "Set your active profile.")

            profileSelectionDropdown.on("change", function (event) {
                const profileId = event.target.value
                gobconfig.activeProfile = profileId
            })

            function populateProfileSelection() {
                profileSelectionDropdown.empty()
                gobconfig.profiles.forEach((profileId) => {
                    var profile = gobconfig.getProfile(profileId)
                    profileSelectionDropdown.append(new Option(profile.profileName, profileId))
                })
                profileSelectionDropdown.val(gobconfig.activeProfile)
            }

            gobconfig.addProfileEventListener((event) => {
                if (event.type === "active")
                    profileSelectionDropdown.val(event.detail.new)
                else
                    populateProfileSelection()
            })

            gobconfig.addPropertyEventListener("profile.name", (event) => {
                const profileId = profileSelectionDropdown.val()
                populateProfileSelection()
                profileSelectionDropdown.val(profileId)
            })

            populateProfileSelection()

            //setup create profile
            $("#cprofiles_profile_new").on("click", function (event) {
                gobconfig.createNewProfile()
            })

            //setup import profile
            $("#cprofiles_profile_import").on("click", function (event) {
                (async () => {
                    let newProfile = await GobchatAPI.importProfile()

                    if (newProfile === undefined || newProfile === null || newProfile.length == 0) {
                        $("#config_dialog_error_text").empty()
                        $("#config_dialog_error_text").append($(
                            `<span>
                                                        Profile can't be loaded.<br>
                                                        Either the format is not supported or the file can't be found/read!<
                                                    </span>
                                                    `
                        ))
                        $("#config_dialog_error").dialog({
                            resizable: false,
                            height: "auto",
                            width: 600,
                            modal: true,
                            buttons: {
                                "Ok": function () {
                                    $(this).dialog("close");
                                }
                            }
                        })
                        return
                    }

                    newProfile = JSON.parse(newProfile)
                    gobconfig.importProfile(newProfile)
                })()
            })

            // gobconfig.addEventListener("profile.add", (event) => { })
            // gobconfig.addEventListener("profile.remove", (event) => { })
            //  gobconfig.addEventListener("profile.changed", (event) => { })

            const profileTable = $("#cprofiles_profiles > tbody")
            const template = $("#cprofiles_template_profiles_entry")

            function populateProfileTable() {
                profileTable.empty()
                gobconfig.profiles.forEach((profileId) => {
                    const profile = gobconfig.getProfile(profileId)

                    const rowElement = $(template.html())
                    rowElement.appendTo(profileTable)

                    rowElement.attr("data-profile-id", profile.profileId)

                    const txtProfileName = rowElement.find("#profile_name")
                    txtProfileName.on("change", function (event) {
                        profile.profileName = event.target.value || "Unnamed"
                    })
                    txtProfileName.val(profile.profileName)

                    const btnActiveProfile = rowElement.find("#profile_activate")
                    btnActiveProfile.on("click", function (event) {
                        gobconfig.activeProfile = profile.profileId
                    })
                    if (gobconfig.activeProfile === profile.profileId)
                        btnActiveProfile.attr("disabled", true)

                    const btnExportProfile = rowElement.find("#profile_export")
                    btnExportProfile.on("click", function (event) {
                        (async () => {
                            const selection = await GobchatAPI.saveFileDialog(`profile_${profile.profileId}.json`)
                            await GobchatAPI.writeTextToFile(selection, JSON.stringify(profile.config))
                        })()
                    })

                    const btnCloneProfile = rowElement.find("#profile_clone")
                    btnCloneProfile.on("click", function (event) {
                        const newProfileId = gobconfig.createNewProfile()
                        gobconfig.copyProfile(profile.profileId, newProfileId)
                    })

                    const btnCopyProfile = rowElement.find("#profile_copy")
                    btnCopyProfile.on("click", function (event) {
                        ConfigHelper.showProfileIdSelectionDialog(selectedId => gobconfig.copyProfile(selectedId, profile.profileId), { exclude: profile.profileId })
                    })
                    if (gobconfig.profiles.length <= 1)
                        btnCopyProfile.attr("disabled", true)

                    const btnDefaultProfile = rowElement.find("#profile_default")
                    btnDefaultProfile.on("click", function (event) {
                        if (window.confirm("Restore all settings for this profile to default?\nEverything will be deleted!\nPress save afterwards.")) {
                            profile.restoreDefaultConfig()
                        }
                    })

                    const btnDeleteProfile = rowElement.find("#profile_delete")
                    btnDeleteProfile.on("click", function (event) {
                        gobconfig.deleteProfile(profile.profileId)
                    })
                    if (gobconfig.profiles.length <= 1)
                        btnDeleteProfile.attr("disabled", true)
                })
            }

            gobconfig.addProfileEventListener((event) => {
                populateProfileTable()
            })
            populateProfileTable()

            gobconfig.addPropertyEventListener("profile.name", (event) => {
                const profile = gobconfig.getProfile(event.source)
                profileTable.find(`tr[data-profile-id='${profile.profileId}']`).find("#profile_name").val(profile.get("profile.name"))
            })

        }());
    </script>
</body>
</html>