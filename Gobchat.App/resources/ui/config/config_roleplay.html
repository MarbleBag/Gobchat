<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title></title>
</head>
<body>
    <button class="gob-button-tertiary gob-button-copypage" id="croleplay_copyprofile"><i class="fas fa-clone"></i></button>

    <div class="gob-config-group" style="overflow-x: auto;">
        <table id="croleplay_roleplay" class="gob-table gob-table-row-hover">
            <thead>
                <tr>
                    <th data-gob-locale-text="config.roleplay.tokentbl.header.name"></th>
                    <th data-gob-locale-text="config.roleplay.tokentbl.header.color"></th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>

        <template id="croleplay_template_roleplayentry">
            <tr>
                <td>
                    <label class="entry-label"></label>
                </td>
                <td>
                    <div>
                        <input class="entry-color-forground" type="text" />
                        <button class="entry-color-forground-reset gob-button-tertiary gob-button-reset"
                                data-gob-locale-title="config.main.resetbutton.tooltip">
                            <i class='fas fa-undo-alt'></i>
                        </button>
                    </div>
                </td>
            </tr>
        </template>
    </div>
    <p>

        <div>
            <button id="croleplay_segments_add" class="gob-button-secondary">
                <i class="fa fa-plus"></i>
                <span data-gob-locale-text="config.roleplay.tokentbl.new"></span>
            </button>
            <button id="croleplay_segments_reset" class="gob-button-secondary">
                <i class="fas fa-undo-alt"></i>
                <span data-gob-locale-text="config.roleplay.tokentbl.reset"></span>
            </button>
        </div>
        <div id="croleplay_segments_table">
        </div>

        <template id="croleplay_template_segmentsentry">
            <div data-gob-entryid>
                <h4>
                    <span class="ui-gc-group-header">
                        <span>
                            <span class="tmpl-header-index"></span>
                            <span>. </span>
                            <span class="tmpl-header-name"></span>
                            <!--
                            <span class="tmpl-header-name-type"></span>
                            <span> starts with </span>
                            <span class="tmpl-header-name-start"></span>
                            <span> and ends with </span>
                            <span class="tmpl-header-name-end"></span>
                            -->
                        </span>

                        <span style="float:right;">
                            <button class="tmpl-delete-entry gob-button-tertiary gob-button-delete"
                                    data-gob-locale-title="config.main.deletebutton.tooltip">
                                <i class="fa fa-trash"></i>
                            </button>
                        </span>
                    </span>
                </h4>
                <div>
                    <div class="gob-config-group-item">
                        <span data-gob-locale-text="config.roleplay.entry.info"></span>
                    </div>
                    <div class="gob-config-group">
                        <div class="gob-config-group-item">
                            <div>
                                <input type="checkbox" class="tmpl-entry-active" />
                                <div data-gob-locale-text="config.roleplay.entry.active"></div>
                            </div>
                        </div>
                    </div>

                    <div class="gob-config-group">
                        <div class="gob-config-group-item">
                            <table>
                                <tr>
                                    <td>
                                        <span>Type</span>
                                    </td>
                                    <td>
                                        <select class="tmpl-segment-selector">
                                            <option value=1>SAY</option>
                                            <option value=2>EMOTE</option>
                                            <option value=3>OOC</option>
                                        </select>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <span data-gob-locale-text="config.roleplay.entry.tokenstart"></span>
                                    </td>
                                    <td>
                                        <input type="text" class="tmpl-startTokens" />
                                    </td>
                                    <td>
                                        <span>Unicode:</span>
                                        <span class="tmpl-startTokens-unicode"></span>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <span data-gob-locale-text="config.roleplay.entry.tokenend"></span>
                                    </td>
                                    <td>
                                        <input type="text" class="tmpl-endTokens" />
                                    </td>
                                    <td>
                                        <span>Unicode:</span>
                                        <span class="tmpl-endTokens-unicode"></span>
                                    </td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </template>
    </p>

    <script type="text/javascript">
        'use strict';

        (function () {
            const tblRoleplayContent = [
                { styleId: "style.segment.say", translationId: "main.chat.segment.type.say" },
                { styleId: "style.segment.emote", translationId: "main.chat.segment.type.emote" },
                { styleId: "style.segment.mention", translationId: "main.chat.segment.type.mention" },
                { styleId: "style.segment.ooc", translationId: "main.chat.segment.type.ooc" },
            ]

            const binding = GobConfigHelper.makeDatabinding(gobconfig)

            const tblRoleplay = $("#croleplay_roleplay > tbody")
            const rowTemplate = $('#croleplay_template_roleplayentry')
            tblRoleplayContent.forEach((entry) => {
                const rowEntry = $(rowTemplate.html()).appendTo(tblRoleplay)

                const lblName = rowEntry.find(".entry-label")
                const clrSelectorFG = rowEntry.find(".entry-color-forground")
                const btnResetFG = rowEntry.find(".entry-color-forground-reset")

                lblName.attr("data-gob-locale-text", `${entry.translationId}`)
                lblName.attr("data-gob-locale-title", `${entry.translationId}.tooltip`)

                GobConfigHelper.setConfigKey(clrSelectorFG, entry.styleId + ".color")
                GobConfigHelper.makeColorSelector(clrSelectorFG)
                GobConfigHelper.bindColorSelector(binding, clrSelectorFG)
                btnResetFG.on("click", event => gobconfig.reset(GobConfigHelper.getConfigKey(clrSelectorFG)))
            })

            binding.initialize()

            const segmentsEntryTmpl = $("#croleplay_template_segmentsentry")
            const tblSegments = $("#croleplay_segments_table")
            const ConfigKeyData = "behaviour.segment.data"
            const ConfigKeyOrder = "behaviour.segment.order"

            function convertTokenInput(str) {
                const text = str.trim()
                const split = text.split(" ")
                const data = []
                for (let s of split) {
                    if (s.length === 0) continue
                    s = Gobchat.decodeUnicode(s)
                    data.push(s)
                }
                return data;
            }

            function toUnicodeString(arr) {
                let f = arr.map(s => Gobchat.encodeUnicode(s)).join(" | ")
                return f
            }

            function buildSegmentsTableEntry(entryId) {
                if (entryId === null || entryId === undefined || entryId.length === 0)
                    throw new Error("Invalid entry id")

                const entry = $(segmentsEntryTmpl.html())
                entry.attr("data-gob-entryid", entryId)
                entry.appendTo(tblSegments)

                const binding = GobConfigHelper.makeDatabinding(gobconfig)
                entry.data("configbinding", binding)

                const configKey = ConfigKeyData + "." + entryId

                const btnDelete = entry.find(".tmpl-delete-entry")
                btnDelete.on("click", event => {
                    event.stopPropagation()
                    {
                        (async () => {
                            const result = await GobConfigHelper.showConfirmationDialog({
                                dialogText: "config.roleplay.entry.deleteconfirm",
                            })
                            if (result !== 1) return

                            try {
                                gobconfig.remove(configKey)
                                const order = gobconfig.get(ConfigKeyOrder)
                                _.remove(order, e => e === entryId)
                                gobconfig.set(ConfigKeyOrder, order)
                            } catch (e1) {
                                console.error(e1)
                            }
                        })()
                    }
                })

                const ckbIsActive = entry.find(".tmpl-entry-active")
                GobConfigHelper.setConfigKey(ckbIsActive, configKey + ".active")
                GobConfigHelper.bindCheckbox(binding, ckbIsActive)

                const dpdSegmentType = entry.find(".tmpl-segment-selector")
                GobConfigHelper.setConfigKey(dpdSegmentType, configKey + ".type")
                GobConfigHelper.bindElement(binding, dpdSegmentType)

                const txtStartTokens = entry.find(".tmpl-startTokens")
                GobConfigHelper.setConfigKey(txtStartTokens, configKey + ".startTokens")
                GobConfigHelper.bindElement(binding, txtStartTokens,
                    {
                        elementGetAccessor: ($element) => convertTokenInput($element.val()),
                        elementSetAccessor: ($element, value) => $element.val(value.join(" "))
                    })

                const txtEndTokens = entry.find(".tmpl-endTokens")
                GobConfigHelper.setConfigKey(txtEndTokens, configKey + ".endTokens")
                GobConfigHelper.bindElement(binding, txtEndTokens,
                    {
                        elementGetAccessor: ($element) => convertTokenInput($element.val()),
                        elementSetAccessor: ($element, value) => $element.val(value.join(" "))
                    })

                GobConfigHelper.bindListener(binding, GobConfigHelper.getConfigKey(dpdSegmentType), (value) => {
                    updateEntryHeader()
                })
                GobConfigHelper.bindListener(binding, GobConfigHelper.getConfigKey(txtStartTokens), (value) => {
                    entry.find(".tmpl-startTokens-unicode").text(toUnicodeString(value))
                    updateEntryHeader()
                })
                GobConfigHelper.bindListener(binding, GobConfigHelper.getConfigKey(txtEndTokens), (value) => {
                    entry.find(".tmpl-endTokens-unicode").text(toUnicodeString(value))
                    updateEntryHeader()
                })

                function updateEntryHeader() {
                    {
                        (async () => {
                            const txtStart = gobconfig.get(GobConfigHelper.getConfigKey(txtStartTokens)).join(" or ")
                            const txtEnd = gobconfig.get(GobConfigHelper.getConfigKey(txtEndTokens)).join(" or ")
                            const txtType = dpdSegmentType.find("option:selected").text()
                            const label = await goblocale.getAndFormat("config.roleplay.entry.header", [txtType, txtStart, txtEnd])
                            entry.find(".tmpl-header-name").text(label)
                        })()
                    }
                }

                binding.initialize()
            }

            function addNewEntrySegmentsTable() {
                const data = gobconfig.get(ConfigKeyData)
                const id = GobConfigHelper.generateId(6, Object.keys(data))

                data[id] = {
                    type: 1,
                    startTokens: [],
                    endTokens: [],
                }

                gobconfig.set(ConfigKeyData, data)
                const order = gobconfig.get(ConfigKeyOrder)
                order.push(id)
                gobconfig.set(ConfigKeyOrder, order)
            }
            const btnAddSegment = $("#croleplay_segments_add")
            btnAddSegment.attr("title", "Adds a new box for roleplay formatting")
            btnAddSegment.on("click", (event) => addNewEntrySegmentsTable())

            const btnTblSegmentsReset = $("#croleplay_segments_reset")
            btnTblSegmentsReset.on("click", (event) => {
                gobconfig.reset(ConfigKeyData)
                gobconfig.reset(ConfigKeyOrder)
            })

            function clearSegmentsTable() {
                tblSegments.find("div[data-gob-entryid]").each(function (idx) {
                    $(this).data("configbinding").clear()
                })
                tblSegments.empty()
            }

            function populateSegmentsTable() {
                clearSegmentsTable()
                const ids = gobconfig.get(ConfigKeyOrder)
                ids.forEach(id => buildSegmentsTableEntry(id))

                tblSegments.sortable("refresh")
                tblSegments.accordion("refresh")

                tblSegments.find(".tmpl-header-index").each(function (idx) {
                    $(this).text(idx + 1)
                })

                goblocale.updateElement(tblSegments)
            }

            tblSegments.accordion({
                heightStyle: "content",
                header: "> div > h4",
            })
                .sortable({
                    axis: "y",
                    handle: "h4",
                    stop: function (event, ui) {
                        //update sort order
                        let order = []
                        tblSegments.find("div[data-gob-entryid]").each(function () {
                            order.push($(this).attr("data-gob-entryid"))
                            //order.push($(this).data("groupId"))
                        })

                        order = order.filter(e => e !== null && e !== undefined && e.length > 0)
                        gobconfig.set(ConfigKeyOrder, order)
                    }
                });

            gobconfig.addProfileEventListener((event) => {
                if (event.type === "active")
                    populateSegmentsTable()
            })
            gobconfig.addPropertyEventListener(ConfigKeyOrder, (event) => {
                if (event.isActive)
                    populateSegmentsTable()
            })
            populateSegmentsTable()

            const btnCopyProfile = $("#croleplay_copyprofile")
            const copyKeys = ["behaviour.segment"]
            tblRoleplayContent.forEach(entry => {
                if (entry.styleId === undefined || entry.styleId === null) return
                copyKeys.push(entry.styleId + ".color")
            })
            GobConfigHelper.makeCopyProfileButton(btnCopyProfile, { configKeys: copyKeys })

        }())
    </script>
</body>
</html>