<html class="chatframe">
<head>
    <meta charset="utf-8" />
    <title></title>

    <script src="lib/jquery-3.4.1.min.js"></script>
    <link rel="stylesheet" href="jquery-ui-1.12.1.min.css">
    <script src="lib/jquery-ui-1.12.1.min.js"></script>
    <script src="lib/lodash.min.js"></script>

    <link rel="stylesheet" href="resize_handle.css">
    <script src="resize_handle.js"></script>

    <script defer src="lib/fontawesome/js/all.js"></script>
    <!--<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">-->

    <link rel="stylesheet" href="gobui_default.css">
    <link rel="stylesheet" href="gobui_chat.css">
    <style id="custome_style_id" type="text/css"></style>

    <script src="gobchat/CommonUtilFunctions.js"></script>
    <script src="gobchat/DataChannel.js"></script>
    <script src="gobchat/FFUnicodes.js"></script>

    <script src="gobchat/GobchatConfig.js"></script>

    <script src="gobchat/CommandManager.js"></script>

    <script src="gobchat/StyleBuilder.js"></script>

    <script src="gobchat/Message.js"></script>
    <script src="gobchat/MessageParser.js"></script>
    <script src="gobchat/MessageSoundPlayer.js"></script>
    <script src="gobchat/MessageHtmlBuilder.js"></script>
    <script src="gobchat/GobchatManager.js"></script>
</head>
<body>
    <!--
        TODO:
        - transparency needs to be done via background-image, this version of Xilium does not support rgba
        - transparency can be done by using rgba(r,g,b,a) in CSS
        -  Scrollbar which stays at its current position, except if its all the way down, where it will follow the chat
        - (saveable) Settings
        - Maybe let parsing be done im c# plugin for performance?
        - Store some MB of chat history im plugin for retrieval on reload
        - clear command
    -->

    <div id="container">
        <div id="chatbox" class="chatbox">
            <div id="toolbar" class="chatbox-topbar">
                <div class="chatbox-toolbar">
                    <button id="gobchat_config"><i class="fas fa-cog"></i></button>
                </div>
                <div id="toolbarTabs" class="chatbox-tabs">
                </div>
            </div>
            <div class="chatbox-content-container chatbox-gen">
                <div id="chatboxcontent" class="chatbox-content">
                </div>
            </div>
        </div>
    </div>
</body>

<script>
    'use strict'
    //window.addEventListener('message', event => {})

    //$(window).on("message", function(e){
    //	console.log()
    //	for(let k in e){
    //		console.log(k + " | " + e[k])
    //	}
    //})

    jQuery(function ($) {
        window.chatManager = new Gobchat.GobchatManager("chatboxcontent")
        window.chatManager.init()

        $("#gobchat_config").on("click", function (e) {

            const isConfigOpen = localStorage.getItem("gobchat-config-open") || "false"

            if (isConfigOpen === "true")
                return

            localStorage.setItem("gobchat-config-open", "true")

            window.chatManager.saveConfigToLocalStore()

            const handle = window.open("config/config.html", 'Settings', 'width=900,height=600')
            handle.focus()

            const timer = setInterval(function () {
                if (handle.closed) {
                    clearInterval(timer);
                    localStorage.removeItem("gobchat-config-open")
                    const result = handle.window.gobresult
                    if (result === "success") {
                        window.chatManager.loadConfigFromLocalStore()
                        window.chatManager.updateStyle()
                    }
                }
            }, 1000);
        })

        $(window).on("message", function (e) {
            //TODO somehow check for the correct data
            //console.log(e)
            // window.chatManager.loadConfigFromLocalStore()
            // window.chatManager.updateStyle()
        })

        // test
        function runTest() {
            function fireMessageEvent(e) {
                const msg = { detail: { type: e.channel || Gobchat.ChannelEnum.PARTY, timestamp: "HH:mm", source: e.source || "Browser", message: e.message || "Empty" } }
                window.chatManager.onNewMessageEvent(msg)
            }

            const textMessages = [
                { channel: Gobchat.ChannelEnum.PARTY, message: '"Say" ((ooc)) *emote* mention' }, //base test
                { channel: Gobchat.ChannelEnum.PARTY, message: '"Mention contained in say"' },
                { channel: Gobchat.ChannelEnum.PARTY, message: '((Mention contained in ooc))' },
                { channel: Gobchat.ChannelEnum.PARTY, message: '*Mention contained in emote*' },
                { channel: Gobchat.ChannelEnum.SAY, message: '"Some speech", followed by an emote, "and some more speech."' },
                { channel: Gobchat.ChannelEnum.SAY, message: 'Display of some special html characters: < > | <<  ≫ « »' },
                { channel: Gobchat.ChannelEnum.EMOTE, message: 'Display of some special ffxiv characters: \uE0BB' },
                { channel: Gobchat.ChannelEnum.PARTY, message: '"Say that\'s divided by some *emote characters* but should still be displayed correctly."' },
                { channel: Gobchat.ChannelEnum.PARTY, message: '*An emote mixed with "for some important stuff" but contained in an emote*' },
                { channel: Gobchat.ChannelEnum.PARTY, message: 'Ooc mixed inbetween "some ((ooc)) say" *or ((ooc)) emote*' },
                { channel: Gobchat.ChannelEnum.PARTY, message: 'Ooc mixed inbetween "some ((ooc)) say" *or ((ooc)) emote*' },
                { channel: Gobchat.ChannelEnum.PARTY, message: '"Mixed stuff *inbetween but the enclosing character* was forgotten.' },
                { channel: Gobchat.ChannelEnum.PARTY, message: '»Say mixed with different types of«, of symbols, »to see if they work«' },
                { channel: Gobchat.ChannelEnum.PARTY, message: '«Say mixed with different types of», of symbols, «to see if they work»' },
            ]

            textMessages.forEach(e => fireMessageEvent(e))

            const fillMe = Array.from({ length: 1 }, (v, k) => `|Text1 | <Text 2> "Say" ((ooc)) *emote*   | oof |  Say, *emote* and ((ooc)) - ${k + 1} <emote> \u226Btext long\u226A`).map(e => { return { message: e, source: "Di'e I'of-oOdin" } })
            fillMe.forEach(e => fireMessageEvent(e))
        }

        // window.setTimeout(runTest, 10000);

    })
</script>
</html>