<html class="chatframe">
<head>
    <meta charset="utf-8" />
    <title></title>

    <script src="lib/jquery-3.4.1.min.js"></script>
    <link rel="stylesheet" href="jquery-ui-1.12.1.min.css">
    <script src="lib/jquery-ui-1.12.1.min.js"></script>
    <script src="lib/lodash.min.js"></script>

    <link rel="stylesheet" href="resize_handle.css">
    <script src="resize_handle.js"></script>

    <script defer src="lib/fontawesome/js/all.js"></script>
    <!--<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">-->

    <link rel="stylesheet" href="gobui_default.css">
    <link rel="stylesheet" href="gobui_chat.css">
    <style id="custome_style_id" type="text/css"></style>

    <script src="gobchat/CommonUtilFunctions.js"></script>
    <script src="gobchat/DataChannel.js"></script>
    <script src="gobchat/FFUnicodes.js"></script>

    <script src="gobchat/GobchatConfig.js"></script>

    <script src="gobchat/CommandManager.js"></script>
    <script src="gobchat/StyleBuilder.js"></script>

    <script src="gobchat/Message.js"></script>
    <script src="gobchat/MessageParser.js"></script>
    <script src="gobchat/MessageSoundPlayer.js"></script>
    <script src="gobchat/MessageHtmlBuilder.js"></script>
    <script src="gobchat/GobchatManager.js"></script>
</head>
<body>
    <!--
        TODO:
        - transparency can be done by using rgba(r,g,b,a) in CSS
        - Maybe let parsing be done im c# plugin for performance?
        - Store some MB of chat history im plugin for retrieval on reload
        - clear command
    -->

    <div id="container">
        <div id="chatbox" class="chatbox">
            <div id="chatbox_toolba_top" class="chatbox-topbar chatbox-toolbar">
                <button id="gobchat_showconfig"><i class="fas fa-cog"></i></button>
                <button id="gobchat_togglechatsearch"><i class="fas fa-search"></i></button>
            </div>
            <div id="chatbox_content" class="chatbox-content chatbox-gen">
            </div>
            <div id="chatbox_toolba_bot" class="chatbox-bottombar">
                <div id="chatbox_search">
                    <input id="chatbox_search_txt" />
                    <button id="chatbox_search_hits">0 / 0</button>
                    <button id="chatbox_search_forward"><i class="fas fa-caret-left"></i></button>
                    <button id="chatbox_search_backward"><i class="fas fa-caret-right"></i></button>
                    <button id="chatbox_search_delete"><i class="fas fa-undo-alt"></i></button>
                </div>
                <!--<gobchat-chatsearch id="chatbox_search"></gobchat-chatsearch>-->
            </div>
        </div>
    </div>
</body>

<script>
    'use strict'
    //window.addEventListener('message', event => {})

    //$(window).on("message", function(e){
    //	console.log()
    //	for(let k in e){
    //		console.log(k + " | " + e[k])
    //	}
    //})

    jQuery(function ($) {
        window.chatManager = new Gobchat.GobchatManager("chatbox_content")
        window.chatManager.init()

        $("#gobchat_showconfig").on("click", function (e) {
            const isConfigOpen = localStorage.getItem("gobchat-config-open") || "false"

            if (isConfigOpen === "true")
                return

            localStorage.setItem("gobchat-config-open", "true")

            window.chatManager.saveConfigToLocalStore()

            const handle = window.open("config/config.html", 'Settings', 'width=900,height=600')
            handle.saveConfig = function () {
                window.chatManager.loadConfigFromLocalStore()
                window.chatManager.updateStyle()
            }

            handle.focus()

            const timer = setInterval(function () {
                if (handle.closed) {
                    clearInterval(timer);
                    localStorage.removeItem("gobchat-config-open")
                }
            }, 1000);
        })

        function toggleChatSearch() {
            $("#chatbox_search").toggle()
            if ($("#chatbox_search").is(":visible"))
                $("#chatbox_search_txt").focus()
        }

        $("#chatbox_search").hide()
        $("#gobchat_togglechatsearch").on("click", (e) => { toggleChatSearch() })
        document.addEventListener("ToggleSearchEvent", (e) => { toggleChatSearch() })

        $("#chatbox_search").on("keyup", function (e) {
            if (event.keyCode !== 13) // enter
                return
            startChatSearch()
        })

        $("#chatbox_search_delete").on("click", function (e) {
            clearChatSearch()
        })

        function chatSearchProcessCounter(fun) {
            const $counter = $("#chatbox_search_hits")
            const txt = $counter.text()
            const split = txt.split("/")
            let total = 0
            let current = 0
            if (split.length == 2) {
                total = parseInt(split[0])
                current = parseInt(split[1])
            }
            const [nTotal, nCurrent] = fun(total, current)
            $counter.text(`${nTotal} / ${nCurrent}`)
        }

        $("#chatbox_search_backward").on("click", function (e) {
            const currentSearch = $(".chatbox-search-msg-selected")
            currentSearch.removeClass("chatbox-search-msg-selected")
            const prevSearch = currentSearch.nextUntil(".chatbox-search-msg-found").addBack().last().next(".chatbox-search-msg-found")
            if (prevSearch.length !== 0) {
                prevSearch.addClass("chatbox-search-msg-selected")
                chatSearchProcessCounter((t, c) => [t, c - 1])
            } else {
                $(".chatbox-search-msg-found").first().addClass("chatbox-search-msg-selected")
                chatSearchProcessCounter((t, c) => [t, t])
            }
            scrollChatSearch()
        })

        $("#chatbox_search_forward").on("click", function (e) {
            const currentSearch = $(".chatbox-search-msg-selected")
            currentSearch.removeClass("chatbox-search-msg-selected")
            const prevSearch = currentSearch.prevUntil(".chatbox-search-msg-found").addBack().first().prev(".chatbox-search-msg-found")
            if (prevSearch.length !== 0) {
                prevSearch.addClass("chatbox-search-msg-selected")
                chatSearchProcessCounter((t, c) => [t, c + 1])
            } else {
                $(".chatbox-search-msg-found").last().addClass("chatbox-search-msg-selected")
                chatSearchProcessCounter((t, c) => [t, 1])
            }
            scrollChatSearch()
        })

        $("#chatbox_search_hits").on("click", function (e) {
            scrollChatSearch()
        })

        function startChatSearch() {
            clearChatSearch()

            let searchText = $("#chatbox_search_txt").val()
            if (searchText === null || searchText === undefined) return
            searchText = searchText.trim().toUpperCase()
            if (searchText.length === 0) return

            $("#chatbox_content").find(".message-body-base").each(function (i, e) {
                if ($(this).text().toUpperCase().indexOf(searchText) >= 0)
                    $(this).addClass("chatbox-search-msg-found")
            })

            const allHits = $(".chatbox-search-msg-found")
            allHits.last().addClass("chatbox-search-msg-selected")
            chatSearchProcessCounter((t, c) => [allHits.length, 1])

            scrollChatSearch()
        }

        function buildSearchFunction(txt, advanced) {

        }

        function clearChatSearch() {
            $("#chatbox_content").find(".chatbox-search-msg-selected").removeClass("chatbox-search-msg-selected")
            $("#chatbox_content").find(".chatbox-search-msg-found").removeClass("chatbox-search-msg-found")
            chatSearchProcessCounter((t, c) => [0, 0])
        }

        function scrollChatSearch() {
            const target = $("#chatbox_content").find(".chatbox-search-msg-selected")[0]
            if (!target)
                return

            const frame = $("#chatbox_content")[0]

            const containerTop = frame.scrollTop
            const containerBot = frame.clientHeight + containerTop
            const elementTop = target.offsetTop - frame.offsetTop
            const elementBot = target.clientHeight + elementTop
            const isVisible = containerTop <= elementTop && elementBot <= containerBot

            if (isVisible)
                return

            const position = elementTop;

            $(frame).animate({
                scrollTop: position /// $(".chatbox-search-msg-active").first().offset().top // $("chatboxcontent")[0].scrollHeight - $("chatboxcontent")[0].clientHeight
            }, 100)
        }

        // test
        function runTest() {
            function fireMessageEvent(e) {
                const msg = { detail: { type: e.channel || Gobchat.ChannelEnum.PARTY, timestamp: "HH:mm", source: e.source || "Browser", message: e.message || "Empty" } }
                window.chatManager.onNewMessageEvent(msg)
            }

            const textMessages = [
                { channel: Gobchat.ChannelEnum.PARTY, message: '"Say" ((ooc)) *emote* mention' }, //base test
                { channel: Gobchat.ChannelEnum.PARTY, message: '"Mention contained in say"' },
                { channel: Gobchat.ChannelEnum.PARTY, message: '((Mention contained in ooc))' },
                { channel: Gobchat.ChannelEnum.PARTY, message: '*Mention contained in emote*' },
                { channel: Gobchat.ChannelEnum.SAY, message: '"Some speech", followed by an emote, "and some more speech."' },
                { channel: Gobchat.ChannelEnum.SAY, message: 'Display of some special html characters: < > | <<  ≫ « »' },
                { channel: Gobchat.ChannelEnum.EMOTE, message: 'Display of some special ffxiv characters: \uE0BB' },
                { channel: Gobchat.ChannelEnum.PARTY, message: '"Say that\'s divided by some *emote characters* but should still be displayed correctly."' },
                { channel: Gobchat.ChannelEnum.PARTY, message: '*An emote mixed with "for some important stuff" but contained in an emote*' },
                { channel: Gobchat.ChannelEnum.PARTY, message: 'Ooc mixed inbetween "some ((ooc)) say" *or ((ooc)) emote*' },
                { channel: Gobchat.ChannelEnum.PARTY, message: 'Ooc mixed inbetween "some ((ooc)) say" *or ((ooc)) emote*' },
                { channel: Gobchat.ChannelEnum.PARTY, message: '"Mixed stuff *inbetween but the enclosing character* was forgotten.' },
                { channel: Gobchat.ChannelEnum.PARTY, message: '»Say mixed with different types«, of symbols, »to see if they work«' },
                { channel: Gobchat.ChannelEnum.PARTY, message: '«Say mixed with different types», of symbols, «to see if they work»' },
            ]

            textMessages.forEach(e => fireMessageEvent(e))

            const fillMe = Array.from({ length: 20 }, (v, k) => `|Text1 | <Text 2> "Say" ((ooc)) *emote*   | oof |  Say, *emote* and ((ooc)) - ${k + 1} <emote> \u226Btext long\u226A`).map(e => { return { message: e, source: "Di'e I'of-oOdin" } })
            fillMe.forEach(e => fireMessageEvent(e))
        }

        window.setTimeout(runTest, 10000);

    })
</script>
</html>